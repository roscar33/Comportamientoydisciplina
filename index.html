<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Administrativo Docente ¬∑ Primaria 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #1b5e20;        
      --primary-light: #2e7d32; 
      --accent: #0288d1;          
      --tools-color: #f57c00;
      --corr-color: #6a1b9a;
      --bg-body: #c8e6c9;        
      --text-main: #0f172a;
      --card-bg: #ffffff;
      --radius-xl: 24px;
      --radius-md: 12px;
      --shadow: 0 4px 15px rgba(27, 94, 32, 0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-body); min-height: 100vh; padding: 16px; color: var(--text-main); display: flex; justify-content: center; }
    .app-shell { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 20px; }

    .top-bar { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 10px 20px; background: #ffffff; border-radius: 50px; box-shadow: var(--shadow); border: 1px solid #c8e6c9; }
    .brand-group { display: flex; align-items: center; gap: 12px; flex: 1; }
    .brand-logo { width: 45px; height: 45px; }
    .brand-logo img { width: 100%; height: 100%; object-fit: contain; }
    .brand-title { font-size: 15px; font-weight: 800; color: var(--primary); line-height: 1.1; }

    .conn-indicator { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #e0e0e0; transition: 0.3s; }
    .conn-online { background-color: #22c55e; }
    .conn-offline { background-color: #ef4444; }

    .nav-tabs { display: flex; background: #fff; padding: 5px; border-radius: 50px; box-shadow: var(--shadow); margin-bottom: 10px; gap: 5px; flex-wrap: wrap; }
    .nav-btn { flex: 1; border: none; background: transparent; padding: 12px; border-radius: 40px; font-weight: 700; color: #666; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; font-size: 11px; }
    .nav-btn.active-asis { background: var(--accent); color: white; }
    .nav-btn.active-obs { background: var(--primary); color: white; }
    .nav-btn.active-herramientas { background: var(--tools-color); color: white; }
    .nav-btn.active-corr { background: var(--corr-color); color: white; }

    .card { background: var(--card-bg); border-radius: var(--radius-xl); padding: 24px; box-shadow: var(--shadow); border: 1px solid white; position: relative; margin-bottom: 20px; }
    .card-title { font-size: 18px; font-weight: 800; color: var(--primary); margin-bottom: 15px; }

    .attendance-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
    .att-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; }
    .att-info { display: flex; flex-direction: column; gap: 2px; }
    .att-name { font-weight: 600; font-size: 14px; color: #334155; }
    .att-counter { font-size: 10px; font-weight: bold; color: #dc2626; background: #fee2e2; padding: 1px 6px; border-radius: 4px; align-self: flex-start; }
    .att-options { display: flex; gap: 5px; }
    .att-btn { border: 1px solid #cbd5e1; background: #fff; color: #64748b; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .att-btn.active-p { background: #dcfce7; color: #166534; border-color: #86efac; }
    .att-btn.active-e { background: #ffedd5; color: #9a3412; border-color: #fdba74; }
    .att-btn.active-i { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }

    .compilation-monthly { margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 20px; border: 1px solid #bae6fd; text-align: center; }
    .comp-select { padding: 10px; width: 100%; border-radius: 12px; border: 1px solid #7dd3fc; margin-bottom: 10px; font-weight: bold; color: var(--accent); }

    .excusa-card { background: #fff; border-radius: 18px; border-left: 6px solid var(--accent); padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); border: 1px solid #e1f5fe; }
    .excusa-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; margin-bottom: 10px; }
    .excusa-name { font-weight: 800; color: #1e293b; font-size: 14px; }
    .excusa-date { font-size: 10px; font-weight: bold; color: #64748b; background: #f1f5f9; padding: 3px 8px; border-radius: 6px; }
    .excusa-body { font-size: 13px; color: #475569; line-height: 1.5; }
    .excusa-firma-wrap { text-align: right; margin-top: 10px; border-top: 1px dashed #eee; padding-top: 10px; }
    .excusa-firma-img { max-height: 50px; border: 1px solid #eee; background: #fff; }

    .obs-list-card { background: #fff; border-radius: 18px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); border: 1px solid #e1f5fe; border-left: 6px solid var(--primary); }
    .sigs-history-row { display: flex; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee; overflow-x: auto; }
    .sig-view-box { flex: 1; text-align: center; min-width: 90px; }
    .sig-view-box span { display: block; font-size: 8px; font-weight: 800; color: #888; text-transform: uppercase; margin-bottom: 4px; }
    .sig-img-history { max-height: 40px; border: 1px solid #f0f0f0; background: #fff; max-width: 100%; object-fit: contain; }

    .search-box-container { margin-bottom: 15px; position: relative; }
    .search-box-container input { width: 100%; padding: 12px 40px 12px 15px; border-radius: 25px; border: 1px solid #ddd; font-size: 14px; outline: none; }
    .search-box-container .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none; }

    .btn-save { background: var(--primary); padding: 15px; border-radius: 30px; font-weight: bold; border: none; cursor: pointer; color: white; font-size: 15px; width: 100%; margin-top: 10px; }
    .btn-historial { background: #455a64; color: white; width: 100%; margin-top: 10px; padding: 12px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; }
    .btn-mini { padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: bold; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
    .btn-pdf-exc { background: #d32f2f; color: white; }
    .btn-pdf-obs { background: #1b5e20; color: white; }
    .btn-edit-obs { background: #0288d1; color: white; }
    .btn-del { background: #fee2e2; color: #dc2626; }
    .btn-reset-ciclo { background: #f57c00; color: white; width: 100%; margin-top: 5px; padding: 10px; border-radius: 30px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; }

    .form-group { margin-bottom: 12px; }
    label { display: block; font-size: 13px; font-weight: 700; color: #333; margin-bottom: 6px; }
    input, textarea, select { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #ccc; background: #fafafa; font-size: 14px; }
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }

    .signature-container { background: #fff; border: 2px dashed #b0bec5; border-radius: 12px; overflow: hidden; }
    canvas.signature-pad { width: 100%; height: 150px; cursor: crosshair; touch-action: none; display: block; }
    .hidden-section { display: none; margin-top: 20px; border-top: 2px dashed #ddd; padding-top: 20px; }

    #deleteModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: white; border-radius: 24px; padding: 25px; width: 100%; max-width: 400px; text-align: center; }

    .btn-tools { background: var(--tools-color); color: white; padding: 18px; border-radius: 15px; font-weight: 800; width: 100%; margin-bottom: 15px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; }

    @media(max-width: 600px) { .nav-tabs { flex-wrap: nowrap; overflow-x: auto; } .nav-btn { min-width: 110px; } }
  </style>
</head>

<body>
<div class="app-shell">

  <header class="top-bar">
    <div class="brand-group">
      <div class="brand-logo"><img src="escudo.png" alt="Escudo" id="schoolLogo"></div>
      <div class="brand-text">
        <div class="brand-title">Panel Administrativo Docente</div>
        <div class="brand-subtitle">Gesti√≥n Escolar ¬∑ 2026</div>
      </div>
    </div>
    <div id="connStatus" class="conn-indicator conn-online"></div>
  </header>

  <nav class="nav-tabs">
    <button id="btnTabAsis" class="nav-btn active-asis" onclick="switchTab('asis')">Asistencia</button>
    <button id="btnTabObs" class="nav-btn" onclick="switchTab('obs')">Observaciones</button>
    <button id="btnTabHerramientas" class="nav-btn" onclick="switchTab('herramientas')">Herramientas</button>
    <button id="btnTabCorr" class="nav-btn" onclick="switchTab('corr')">Correspondencia</button>
  </nav>

  <!-- ASISTENCIA -->
  <div id="view-asis">
    <section class="card" style="border-left: 5px solid var(--accent);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div class="att-info">
          <h2 class="card-title" style="color:var(--accent); margin:0;">Registro Diario</h2>
          <span id="periodoActualLabel" style="font-size:11px; color:#666; font-weight:bold;">Periodo: Cargando...</span>
        </div>
        <input type="date" id="fechaAsistencia" style="width:auto; padding:8px;" onchange="window.cargarAsistenciaDelDia()">
      </div>

      <div id="attendanceList" class="attendance-grid"></div>
      <button class="btn-save" style="background:var(--accent);" onclick="window.guardarAsistencia()">üíæ GUARDAR ASISTENCIA</button>

      <div class="compilation-monthly">
        <h3 style="font-size:13px; color:var(--accent); margin-bottom:8px;">Reporte Mensual</h3>
        <p style="font-size:11px; color:#666; margin-bottom:10px;">(El reporte mensual siempre mostrar√° los datos del mes elegido, sin importar los reseteos de periodo)</p>

        <select id="mesSeleccionadoAsis" class="comp-select">
          <option value="01">Enero</option><option value="02">Febrero</option><option value="03">Marzo</option>
          <option value="04">Abril</option><option value="05">Mayo</option><option value="06">Junio</option>
          <option value="07">Julio</option><option value="08">Agosto</option><option value="09">Septiembre</option>
          <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
        </select>

        <button class="btn-mini btn-pdf-exc" style="width:100%; padding:14px; border-radius:30px;" onclick="window.descargarReporteMensualAsis()">
          üìä DESCARGAR COMPILACI√ìN (PDF)
        </button>

        <button class="btn-reset-ciclo" style="background:#2e7d32; border:2px solid #1b5e20; margin-top:15px; padding:12px; width:100%;" onclick="window.resetearFaltasPeriodo()">
          üîÑ INICIAR NUEVO PERIODO (BORR√ìN Y CUENTA NUEVA)
        </button>
      </div>

      <div style="margin:25px 0 15px; border-bottom:2px dashed #e0e0e0; color:var(--accent); font-weight:700; font-size:14px;">Gesti√≥n de Excusas</div>
      <button type="button" class="btn-historial" style="background:var(--accent);" onclick="toggleHistorial('historialExc')">üì© VER EXCUSAS RECIBIDAS</button>

      <div id="historialExc" class="hidden-section">
        <div class="search-box-container">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchExcusaInput" placeholder="Buscar estudiante o motivo..." oninput="window.filtrarExcusas()">
        </div>
        <div id="listaExcusas">Cargando...</div>
      </div>
    </section>
  </div>

  <!-- OBSERVACIONES -->
  <div id="view-obs" style="display:none;">
    <section class="card">
      <h2 class="card-title">üìù Registro de Observaciones</h2>
      <form id="formRegistro">
        <input type="hidden" id="editObsId">
        <div class="form-grid">
          <div class="form-group">
            <label>Tipo</label>
            <select id="tipoRegistro"><option>Comportamental</option><option>Acad√©mico</option></select>
          </div>
          <div class="form-group">
            <label>Fecha</label>
            <input type="date" id="fecha" required>
          </div>
        </div>

        <div class="form-group">
          <label>Seleccionar Estudiante</label>
          <select id="selectEstudianteObs" required>
            <option value="" disabled selected>Elija un estudiante de la lista...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea id="comportamiento" placeholder="Novedad presentada..."></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group"><label>Descargos</label><textarea id="descargos"></textarea></div>
          <div class="form-group"><label>Procedimiento</label><textarea id="procedimiento"></textarea></div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Firma Estudiante</label>
            <div class="signature-container"><canvas id="sigStudent" class="signature-pad"></canvas></div>
            <button type="button" style="border:none; background:none; color:red; font-size:10px; cursor:pointer;" onclick="limpiarPad('sigStudent')">Limpiar</button>
          </div>
          <div class="form-group">
            <label>Firma Docente</label>
            <div class="signature-container"><canvas id="sigTeacher" class="signature-pad"></canvas></div>
            <button type="button" style="border:none; background:none; color:red; font-size:10px; cursor:pointer;" onclick="limpiarPad('sigTeacher')">Limpiar</button>
          </div>
        </div>

        <button type="submit" class="btn-save" id="btnSubmitObs">ENVIAR REGISTRO</button>

        <div style="background:#fff3e0; padding:15px; border-radius:15px; margin-top:15px; border:1px solid #ffe0b2;">
          <p style="font-size:12px; font-weight:bold; margin-bottom:5px; color:#e65100;">Controles de Ciclo:</p>
          <button type="button" class="btn-reset-ciclo" onclick="window.resetearCicloEstudiante()">üîÑ REINICIAR CICLO PARA ESTE ESTUDIANTE</button>
          <button type="button" class="btn-save" style="background:#43a047; margin-top:10px;" onclick="window.descargarPDFUnificado()">üìÑ GENERAR PDF UNIFICADO (CON ADVERTENCIAS)</button>
        </div>

        <button type="button" class="btn-historial" onclick="toggleHistorial('historialObs')">üìÇ VER HISTORIAL COMPLETO</button>
      </form>

      <div id="historialObs" class="hidden-section">
        <div class="search-box-container">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchHistoryInput" placeholder="Buscar en observaciones..." oninput="window.filtrarHistorialObs()">
        </div>
        <div id="listaRegistros"></div>
      </div>
    </section>
  </div>

  <!-- HERRAMIENTAS -->
  <div id="view-herramientas" style="display:none;">
    <section class="card" style="border-left: 5px solid var(--tools-color);">
      <h2 class="card-title" style="color:var(--tools-color);">üß∞ Herramientas</h2>
      <a href="https://roscar33.github.io/Diariodeprocesos2026/" target="_blank" class="btn-tools">üìì DIARIO DE PROCESOS</a>
      <a href="https://roscar33.github.io/PLANILLASDENOTAS/" target="_blank" class="btn-tools">üìä PLANILLA DE NOTAS</a>
      <a href="https://roscar33.github.io/Bancodecriterios/" target="_blank" class="btn-tools">üìö TEMARIOS</a>
      <a href="https://roscar33.github.io/Horario/" target="_blank" class="btn-tools">üïí HORARIO DE CLASES</a>
    </section>
  </div>

  <!-- CORRESPONDENCIA -->
  <div id="view-corr" style="display:none;">
    <section class="card" style="border-left: 5px solid var(--corr-color);">
      <h2 class="card-title" style="color:var(--corr-color);">üì® Correspondencia</h2>
      <div id="listaCorrespondencia">Cargando...</div>
    </section>
  </div>

</div>

<!-- MODAL DELETE -->
<div id="deleteModal">
  <div class="modal-box">
    <h3 style="color:#dc2626">¬øEliminar registro?</h3>
    <p style="margin:10px 0; font-size:14px; color:#666">Esta acci√≥n es irreversible.</p>
    <button class="btn-save" id="confirmDeleteBtn" style="background:#dc2626; width:100%">Eliminar ahora</button>
    <button onclick="closeDeleteModal()" style="border:none; background:none; color:#666; margin-top:15px; cursor:pointer; font-weight:bold">Cancelar</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    updateDoc,
    deleteDoc,
    doc,
    onSnapshot,
    setDoc,
    getDoc,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
    authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
    projectId: "diariodeprocesos-6f78d",
    storageBucket: "diariodeprocesos-6f78d.firebasestorage.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const estudiantesBase = [
    { doc: "1157463842", nombre: "BERRIO CORREA VALENTINA" },
    { doc: "1038213324", nombre: "GUZMAN CORREA DYLAN" },
    { doc: "1072263423", nombre: "MEDINA POLO JESUS DAVID" },
    { doc: "1041636093", nombre: "MEJIA VALLEJO TOMAS" },
    { doc: "1041636021", nombre: "VARELAS BARRIENTOS MAXIMILIANO" }
  ];

  const pads = new Map();
  let currentDeleteInfo = { id: null, collection: null };
  let localExcusas = [];
  let localRegistrosObs = [];
  let localAsistenciaCompleta = [];
  let periodoActualAsis = 1;

  // ------- Helpers PDF (logo dataURL para que no falle) -------
  function getLogoDataUrl() {
    try {
      const img = document.getElementById('schoolLogo');
      if (!img || !img.complete || !img.naturalWidth) return null;
      const c = document.createElement('canvas');
      c.width = img.naturalWidth;
      c.height = img.naturalHeight;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0);
      return c.toDataURL('image/png');
    } catch(e) { return null; }
  }

  // ------- Navegaci√≥n -------
  window.switchTab = (t) => {
    ['view-asis', 'view-obs', 'view-herramientas', 'view-corr'].forEach(v => document.getElementById(v).style.display = 'none');
    ['btnTabAsis', 'btnTabObs', 'btnTabHerramientas', 'btnTabCorr'].forEach(b => document.getElementById(b).className = 'nav-btn');

    document.getElementById('view-' + t).style.display = 'block';
    const btnId = 'btnTab' + t.charAt(0).toUpperCase() + t.slice(1);
    document.getElementById(btnId).className = 'nav-btn active-' + t;

    if (t === 'obs') setTimeout(() => { initPad('sigStudent'); initPad('sigTeacher'); }, 250);
    if (t === 'corr') cargarCorrespondencia();
  };

  // =========================================================
  // ‚úÖ FIRMAS (CORREGIDO): evita trazos accidentales con stylus
  // =========================================================
  function initPad(id) {
    const c = document.getElementById(id);
    if (!c) return;

    // Evitar doble inicializaci√≥n si cambias de pesta√±a
    if (c.dataset.padReady === "1") return;
    c.dataset.padReady = "1";

    const ctx = c.getContext("2d", { willReadFrequently: true });

    const resize = () => {
      const ratio = window.devicePixelRatio || 1;
      const rect = c.getBoundingClientRect();

      c.width = Math.floor(rect.width * ratio);
      c.height = Math.floor(150 * ratio);

      // Coordenadas en CSS pixels
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#000";
    };

    resize();
    window.addEventListener("resize", resize);

    let drawing = false;
    let lastX = null;
    let lastY = null;

    const getPos = (e) => {
      const r = c.getBoundingClientRect();
      return { x: e.clientX - r.left, y: e.clientY - r.top };
    };

    const endStroke = () => {
      drawing = false;
      lastX = null;
      lastY = null;
      ctx.beginPath(); // rompe el path para que no conecte
    };

    c.addEventListener("pointerdown", (e) => {
      c.setPointerCapture?.(e.pointerId);

      // Stylus: si no hay presi√≥n es hover -> no iniciar
      if (e.pointerType === "pen" && e.pressure === 0) return;

      // Mouse: solo si bot√≥n presionado
      if (e.pointerType === "mouse" && e.buttons !== 1) return;

      drawing = true;

      const { x, y } = getPos(e);
      lastX = x;
      lastY = y;

      // Punto inicial
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + 0.01, y + 0.01);
      ctx.stroke();

      pads.set(id, { hasData: true, canvas: c });
    });

    c.addEventListener("pointermove", (e) => {
      if (!drawing) return;

      // Stylus: hover (pressure 0) no dibuja
      if (e.pointerType === "pen" && e.pressure === 0) return;

      // Mouse: si se solt√≥ el bot√≥n, no dibuja
      if (e.pointerType === "mouse" && e.buttons !== 1) return;

      const { x, y } = getPos(e);

      // Si se perdi√≥ el √∫ltimo punto, reiniciar sin unir
      if (lastX === null || lastY === null) {
        lastX = x;
        lastY = y;
        return;
      }

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();

      lastX = x;
      lastY = y;

      pads.set(id, { hasData: true, canvas: c });
    });

    // Cortar trazo en todos los finales posibles
    c.addEventListener("pointerup", endStroke);
    c.addEventListener("pointercancel", endStroke);
    c.addEventListener("pointerleave", endStroke);
    c.addEventListener("lostpointercapture", endStroke);

    pads.set(id, { hasData: false, canvas: c });
  }

  window.limpiarPad = (id) => {
    const p = pads.get(id);
    if (p) {
      p.canvas.getContext("2d").clearRect(0, 0, p.canvas.width, p.canvas.height);
      pads.set(id, {hasData:false, canvas:p.canvas});
    }
  };

  // ------- Asistencia -------
  async function cargarConfiguracionPeriodo() {
    const snap = await getDoc(doc(db, "configuracionGlobal", "asistencia"));
    if (snap.exists()) {
      periodoActualAsis = snap.data().periodoActual || 1;
    } else {
      await setDoc(doc(db, "configuracionGlobal", "asistencia"), { periodoActual: 1 });
    }
    document.getElementById('periodoActualLabel').innerText = `Periodo Actual: #${periodoActualAsis}`;
  }

  window.obtenerFaltasPeriodo = (docEst) => {
    let faltas = 0;
    localAsistenciaCompleta.forEach(registro => {
      if (registro.periodo === periodoActualAsis) {
        const detalle = registro.detalles.find(d => d.doc === docEst);
        if (detalle && (detalle.estado === 'I' || detalle.estado === 'E')) faltas++;
      }
    });
    return faltas;
  };

  let asistenciaTemp = {};
  window.renderAsistencia = () => {
    const list = document.getElementById('attendanceList');
    if(!list) return;

    let html = '';
    estudiantesBase.forEach(e => {
      const s = asistenciaTemp[e.doc] || 'P';
      const totalFaltas = window.obtenerFaltasPeriodo(e.doc);
      html += `
        <div class="att-row">
          <div class="att-info">
            <span class="att-name">${e.nombre}</span>
            <span class="att-counter">${totalFaltas} faltas este periodo</span>
          </div>
          <div class="att-options">
            <button class="att-btn ${s==='P'?'active-p':''}" onclick="setAtt('${e.doc}','P')">P</button>
            <button class="att-btn ${s==='E'?'active-e':''}" onclick="setAtt('${e.doc}','E')">E</button>
            <button class="att-btn ${s==='I'?'active-i':''}" onclick="setAtt('${e.doc}','I')">I</button>
          </div>
        </div>`;
    });
    list.innerHTML = html;
  };

  window.setAtt = (d, s) => { asistenciaTemp[d] = s; window.renderAsistencia(); };

  window.cargarAsistenciaDelDia = async () => {
    const f = document.getElementById('fechaAsistencia').value;
    const snap = await getDoc(doc(db, "controlAsistencia", f));
    asistenciaTemp = (snap.exists() && snap.data().detalles)
      ? snap.data().detalles.reduce((acc,d)=>({...acc,[d.doc]:d.estado}),{})
      : {};
    window.renderAsistencia();
  };

  window.guardarAsistencia = async () => {
    const f = document.getElementById('fechaAsistencia').value;
    const detalles = estudiantesBase.map(e => ({doc:e.doc, nombre:e.nombre, estado:asistenciaTemp[e.doc]||'P'}));
    await setDoc(doc(db, "controlAsistencia", f), { fecha:f, detalles, periodo: periodoActualAsis });
    alert("‚úÖ Registro guardado.");
  };

  window.resetearFaltasPeriodo = async () => {
    const passwordInput = prompt("üîë Ingrese la contrase√±a (9218) para iniciar un nuevo periodo de conteo:");
    if (passwordInput === "9218") {
      if (confirm(`¬øDesea cerrar el periodo #${periodoActualAsis}? Los conteos volver√°n a 0, pero podr√° seguir bajando los reportes mensuales de meses anteriores.`)) {
        try {
          const nuevoPeriodo = periodoActualAsis + 1;
          await updateDoc(doc(db, "configuracionGlobal", "asistencia"), { periodoActual: nuevoPeriodo });
          periodoActualAsis = nuevoPeriodo;
          document.getElementById('periodoActualLabel').innerText = `Periodo Actual: #${periodoActualAsis}`;
          alert(`‚úÖ Periodo #${nuevoPeriodo} iniciado. Conteos reiniciados.`);
          window.renderAsistencia();
        } catch (e) {
          alert("Error al actualizar el periodo.");
        }
      }
    } else {
      alert("‚ùå Contrase√±a incorrecta.");
    }
  };

  function escucharAsistencia() {
    onSnapshot(collection(db, "controlAsistencia"), (snap) => {
      localAsistenciaCompleta = [];
      snap.forEach(docu => localAsistenciaCompleta.push(docu.data()));
      window.renderAsistencia();
    });
  }

  // ------- PDF Mensual Asistencia -------
  window.descargarReporteMensualAsis = async () => {
    const mes = document.getElementById('mesSeleccionadoAsis').value;
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF('l', 'mm', 'a4');
    const logoDataUrl = getLogoDataUrl();

    docPDF.setFillColor(27, 94, 32); docPDF.rect(0, 0, 297, 30, 'F');
    try { if (logoDataUrl) docPDF.addImage(logoDataUrl, 'PNG', 12, 3, 24, 24); } catch(e){}

    docPDF.setTextColor(255, 255, 255);
    docPDF.setFontSize(15); docPDF.setFont("helvetica", "bold");
    docPDF.text("Instituci√≥n Educativa de Mar√≠a, Sede Rural Santa Juana.", 155, 12, { align: "center" });
    docPDF.setFontSize(11);
    docPDF.text(`Reporte Mensual de Asistencia - Mes ${mes} - 2026`, 155, 22, { align: "center" });

    const dias = localAsistenciaCompleta.filter(d => (d.fecha || "").startsWith(`2026-${mes}`));
    dias.sort((a,b) => (a.fecha||"").localeCompare(b.fecha||""));

    if (dias.length === 0) return alert("Sin datos.");

    const head = [["Estudiante", ...dias.map(x => (x.fecha||"").split("-")[2]), "P", "E", "I"]];
    const body = estudiantesBase.map(est => {
      let p=0, e=0, i=0;
      const row = [est.nombre];
      dias.forEach(dia => {
        const st = dia.detalles?.find(x => x.doc === est.doc)?.estado || '-';
        row.push(st);
        if (st==='P') p++; if (st==='E') e++; if (st==='I') i++;
      });
      return [...row, p, e, i];
    });

    docPDF.autoTable({
      startY: 35,
      head,
      body,
      theme: 'grid',
      styles: { fontSize: 7 },
      headStyles: { fillColor: [27,94,32] }
    });

    docPDF.save(`Asistencia_Mes_${mes}_Reporte.pdf`);
  };

  // ------- Excusas -------
  window.filtrarExcusas = () => {
    const queryTxt = (document.getElementById('searchExcusaInput').value || "").toLowerCase();
    const list = document.getElementById('listaExcusas');

    const filtradas = localExcusas.filter(ex => {
      const est = estudiantesBase.find(e => e.doc === ex.documentoEstudiante);
      const nombre = est ? est.nombre.toLowerCase() : "";
      return nombre.includes(queryTxt) || (ex.motivoTipo || "").toLowerCase().includes(queryTxt);
    });

    if (filtradas.length === 0) {
      list.innerHTML = "<p style='text-align:center; padding:20px; color:#666;'>No hay excusas que coincidan.</p>";
      return;
    }

    list.innerHTML = filtradas.map(ex => {
      const est = estudiantesBase.find(e => e.doc === ex.documentoEstudiante);
      return `
        <div class="excusa-card">
          <div class="excusa-header">
            <span class="excusa-name">${est ? est.nombre : 'Desconocido (' + ex.documentoEstudiante + ')'}</span>
            <span class="excusa-date">${ex.fechaInasistencia || ''}</span>
          </div>
          <div class="excusa-body">
            <b>Motivo:</b> ${ex.motivoTipo || ''}<br>
            <b>Detalle:</b> ${ex.motivoDetalle || ''}
          </div>
          <div class="excusa-firma-wrap">
            <span style="font-size:9px; color:#888; display:block; margin-bottom:4px;">FIRMA ACUDIENTE:</span>
            ${ex.firmaAcudiente ? `<img src="${ex.firmaAcudiente}" class="excusa-firma-img">` : `<span style="font-size:11px;color:#999;">(Sin firma)</span>`}
          </div>
          <div style="margin-top:15px; display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn-mini btn-pdf-obs" style="background:#2e7d32;" onclick="window.descargarPDFExcusaCarta('${ex.id}')">üìÑ PDF CARTA</button>
            <button class="btn-mini btn-del" onclick="window.openDeleteModal('${ex.id}','excusasInasistencia')">Eliminar</button>
          </div>
        </div>
      `;
    }).join('');
  };

  window.descargarPDFExcusaCarta = (id) => {
    const ex = localExcusas.find(x => x.id === id); if(!ex) return;
    const est = estudiantesBase.find(e => e.doc === ex.documentoEstudiante);

    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF('p', 'mm', 'a4');
    const logoDataUrl = getLogoDataUrl();
    const margin = 25;

    const fechaDiligenciado = ex.timestamp
      ? new Date(ex.timestamp).toLocaleDateString('es-CO', { day:'numeric', month:'long', year:'numeric' })
      : new Date().toLocaleDateString('es-CO', { day:'numeric', month:'long', year:'numeric' });

    docPDF.setFillColor(27, 94, 32); docPDF.rect(0, 0, 210, 30, 'F');
    try { if (logoDataUrl) docPDF.addImage(logoDataUrl, 'PNG', 12, 4, 22, 22); } catch(e){}

    docPDF.setTextColor(255, 255, 255);
    docPDF.setFontSize(14); docPDF.setFont("helvetica", "bold");
    docPDF.text("INSTITUCI√ìN EDUCATIVA DE MAR√çA", 105, 12, { align: "center" });
    docPDF.setFontSize(10); docPDF.setFont("helvetica", "normal");
    docPDF.text("Sede Rural Santa Juana ¬∑ Gesti√≥n de Procesos 2026", 105, 18, { align: "center" });

    docPDF.setTextColor(0, 0, 0);
    docPDF.setFontSize(11);

    let y = 50;
    docPDF.text(`Yarumal, Antioquia. ${fechaDiligenciado}`, margin, y); y += 15;

    docPDF.setFont("helvetica", "bold");
    docPDF.text("Respetado Docente:", margin, y); y += 6;
    docPDF.text("OSCAR BARRIENTOS", margin, y); y += 6;

    docPDF.setFont("helvetica", "normal");
    docPDF.text("I.E. de Mar√≠a - Sede Santa Juana", margin, y); y += 15;

    docPDF.setFont("helvetica", "bold");
    const nombreE = est ? est.nombre : "___________________________";
    docPDF.text(`ASUNTO: EXCUSA POR INASISTENCIA ESCOLAR - ${nombreE}`, margin, y); y += 15;

    docPDF.text(`Fecha de inasistencia: ${ex.fechaInasistencia || ''}`, margin, y); y += 10;
    docPDF.text(`Motivo: ${ex.motivoTipo || ''}`, margin, y); y += 10;

    docPDF.text("Detalle de la justificaci√≥n:", margin, y); y += 6;
    docPDF.setFont("helvetica", "italic");
    const detalleLines = docPDF.splitTextToSize(`"${ex.motivoDetalle || ''}"`, 160);
    docPDF.text(detalleLines, margin, y); y += (detalleLines.length * 6) + 15;

    docPDF.setFont("helvetica", "normal");
    const despedida = `Agradezco de antemano su comprensi√≥n y colaboraci√≥n para que el estudiante pueda ponerse al d√≠a con las actividades acad√©micas realizadas durante su ausencia.`;
    const lineasDespedida = docPDF.splitTextToSize(despedida, 160);
    docPDF.text(lineasDespedida, margin, y); y += (lineasDespedida.length * 6) + 25;

    docPDF.text("Cordialmente,", margin, y); y += 10;

    if (ex.firmaAcudiente) {
      try { docPDF.addImage(ex.firmaAcudiente, 'PNG', margin, y, 50, 20); y += 22; } catch(e){ y += 10; }
    } else {
      y += 20;
    }

    docPDF.setDrawColor(0); docPDF.line(margin, y, margin + 60, y); y += 5;
    docPDF.setFont("helvetica", "bold");
    docPDF.text("FIRMA DEL ACUDIENTE", margin, y);

    docPDF.setFontSize(8); docPDF.setTextColor(150);
    docPDF.text("Documento generado autom√°ticamente ¬∑ Sistema de Gesti√≥n Primaria 2026", 105, 285, { align: "center" });

    docPDF.save(`Excusa_${nombreE}_${ex.fechaInasistencia || 'sinf'} .pdf`);
  };

  // ------- Observaciones / Ciclos -------
  const ADVERTENCIAS = [
    "PRIMER LLAMADO DE ATENCI√ìN (Advertencia inicial por conducta o rendimiento). Si su hijo ajusta una tercera anotaci√≥n ser√° citado a una entrevista directamente con el docente.",
    "SEGUNDO LLAMADO DE ATENCI√ìN (Citaci√≥n obligatoria a padres de familia para acta de compromiso). Si su hijo ajusta una tercera anotaci√≥n ser√° citado a una entrevista directamente con el docente.",
    "TERCER LLAMADO DE ATENCI√ìN. El estudiante acumul√≥ las tres anotaciones y por lo tanto ser√° citado el acudiente para una entrevista con el profesor."
  ];

  async function getCicloActual(docEst) {
    const snap = await getDoc(doc(db, "configuracionCiclos", docEst));
    return snap.exists() ? (snap.data().cicloActual || 1) : 1;
  }

  window.resetearCicloEstudiante = async () => {
    const docEst = document.getElementById('selectEstudianteObs').value;
    if (!docEst) return alert("Seleccione un estudiante.");
    const conf = await getCicloActual(docEst);
    const nuevoCiclo = conf + 1;
    if (confirm(`¬øDesea cerrar el ciclo #${conf}? La siguiente nota ser√° la #1 del ciclo #${nuevoCiclo}.`)) {
      await setDoc(doc(db, "configuracionCiclos", docEst), { cicloActual: nuevoCiclo });
      alert(`‚úÖ Ciclo reiniciado al #${nuevoCiclo}.`);
    }
  };

  // ‚úÖ PDF INDIVIDUAL
  window.descargarPDFIndividual = (id) => {
    const r = localRegistrosObs.find(x => x.id === id);
    if (!r) return alert("No se encontr√≥ el registro.");

    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF('p', 'mm', 'a4');
    const logoDataUrl = getLogoDataUrl();

    docPDF.setFillColor(27, 94, 32); docPDF.rect(0, 0, 210, 30, 'F');
    try { if (logoDataUrl) docPDF.addImage(logoDataUrl, 'PNG', 8, 3, 24, 24); } catch(e){}

    docPDF.setTextColor(255,255,255);
    docPDF.setFont("helvetica","bold"); docPDF.setFontSize(11);
    docPDF.text("I.E. de Mar√≠a, Sede Santa Juana - Observaci√≥n Individual", 105, 12, {align:"center"});
    docPDF.setFont("helvetica","normal"); docPDF.setFontSize(9);
    docPDF.text(`Estudiante: ${r.nombreEstudiante} | Ciclo #${r.ciclo || 1}`, 105, 19, {align:"center"});

    docPDF.setTextColor(0,0,0);
    let y = 45;

    docPDF.setFont("helvetica","bold"); docPDF.setFontSize(11);
    docPDF.text(`Fecha: ${r.fecha || 'Sin fecha'}`, 14, y); y += 8;

    docPDF.setFont("helvetica","normal"); docPDF.setFontSize(10);
    const desc = docPDF.splitTextToSize(`Descripci√≥n: ${r.comportamiento || ''}`, 180);
    docPDF.text(desc, 14, y); y += desc.length * 6 + 4;

    if (r.descargos) {
      const dd = docPDF.splitTextToSize(`Descargos: ${r.descargos}`, 180);
      docPDF.text(dd, 14, y); y += dd.length * 6 + 4;
    }
    if (r.procedimiento) {
      const pp = docPDF.splitTextToSize(`Procedimiento: ${r.procedimiento}`, 180);
      docPDF.text(pp, 14, y); y += pp.length * 6 + 4;
    }

    docPDF.setFont("helvetica","bold");
    docPDF.setTextColor(200,0,0);
    const adv = docPDF.splitTextToSize(`NOTA DE ADVERTENCIA: ${ADVERTENCIAS[0]}`, 180);
    docPDF.text(adv, 14, y); y += adv.length * 6 + 10;

    docPDF.setTextColor(0,0,0);
    const sigH = 15;
    try { if (r.firmaEstudiante) docPDF.addImage(r.firmaEstudiante, 'PNG', 15, y, 45, sigH); } catch(e){}
    try { if (r.firmaDocente) docPDF.addImage(r.firmaDocente, 'PNG', 80, y, 45, sigH); } catch(e){}
    try { if (r.firmaAcudiente) docPDF.addImage(r.firmaAcudiente, 'PNG', 145, y, 45, sigH); } catch(e){}

    y += sigH + 6;
    docPDF.setFontSize(8);
    docPDF.text("Firma Estudiante", 37, y, {align:"center"});
    docPDF.text("Firma Docente", 102, y, {align:"center"});
    docPDF.text("Firma Acudiente", 167, y, {align:"center"});

    docPDF.save(`Observacion_${r.nombreEstudiante}_${r.fecha || 'sinf'}.pdf`);
  };

  // ‚úÖ PDF UNIFICADO
  window.descargarPDFUnificado = async () => {
    const docEst = document.getElementById('selectEstudianteObs').value;
    if (!docEst) return alert("Seleccione un estudiante.");

    const est = estudiantesBase.find(x => x.doc === docEst);
    const nombreEst = est?.nombre || `(${docEst})`;

    const obsAll = localRegistrosObs
      .filter(r => r.documentoEstudiante === docEst)
      .map(r => ({ ...r, ciclo: (r.ciclo || 1) }))
      .sort((a,b) => {
        const ca = (a.ciclo||1) - (b.ciclo||1);
        if (ca !== 0) return ca;
        const fa = (a.fecha || "").toString();
        const fb = (b.fecha || "").toString();
        if (fa !== fb) return fa.localeCompare(fb);
        return (a.timestamp || "").localeCompare(b.timestamp || "");
      });

    if (obsAll.length === 0) return alert("No hay observaciones para este estudiante.");

    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF('p', 'mm', 'a4');
    const pageHeight = docPDF.internal.pageSize.height;
    const logoDataUrl = getLogoDataUrl();

    let y = 10;

    const header = () => {
      docPDF.setFillColor(27, 94, 32);
      docPDF.rect(0, 0, 210, 30, 'F');
      try { if (logoDataUrl) docPDF.addImage(logoDataUrl, 'PNG', 8, 3, 24, 24); } catch(e){}

      docPDF.setTextColor(255, 255, 255);
      docPDF.setFont("helvetica","bold");
      docPDF.setFontSize(10);
      docPDF.text("I.E. de Mar√≠a, Sede Santa Juana - Seguimiento Unificado", 105, 12, {align:"center"});
      docPDF.setFont("helvetica","normal");
      docPDF.setFontSize(8);
      docPDF.text(`Estudiante: ${nombreEst} | TODOS LOS CICLOS`, 105, 18, {align:"center"});
      y = 38;
    };

    const ensureSpace = (needed) => {
      if (y + needed > pageHeight - 15) {
        docPDF.addPage();
        header();
      }
    };

    const cicloMap = new Map();
    obsAll.forEach(r => {
      const c = r.ciclo || 1;
      if (!cicloMap.has(c)) cicloMap.set(c, []);
      cicloMap.get(c).push(r);
    });
    const ciclos = Array.from(cicloMap.keys()).sort((a,b)=>a-b);
    const titulosNumeros = ["uno","dos","tres","cuatro","cinco","seis","siete","ocho","nueve","diez"];

    header();

    ciclos.forEach((cicloNum, idxCiclo) => {
      const regs = cicloMap.get(cicloNum) || [];

      ensureSpace(18);
      docPDF.setTextColor(0,0,0);
      docPDF.setFont("helvetica","bold");
      docPDF.setFontSize(12);
      docPDF.text(`CICLO #${cicloNum}`, 14, y);
      y += 6;

      docPDF.setFont("helvetica","normal");
      docPDF.setFontSize(9);
      docPDF.setTextColor(90);
      docPDF.text(`Registros en este ciclo: ${regs.length}`, 14, y);
      y += 8;

      docPDF.setDrawColor(220);
      docPDF.line(14, y, 196, y);
      y += 10;

      regs.forEach((r, index) => {
        const numTxt = titulosNumeros[index] || (index+1);
        const advertenciaTxt = ADVERTENCIAS[index] || "Seguimiento continuo de compromisos.";

        const textComportamiento = docPDF.splitTextToSize(`Descripci√≥n: ${r.comportamiento || ""}`, 180);
        const textDescargos = r.descargos ? docPDF.splitTextToSize(`Descargos: ${r.descargos}`, 180) : [];
        const textProc = r.procedimiento ? docPDF.splitTextToSize(`Procedimiento: ${r.procedimiento}`, 180) : [];
        const textAdv = docPDF.splitTextToSize(`NOTA DE ADVERTENCIA: ${advertenciaTxt}`, 180);

        const blockHeight = 15 + (textComportamiento.length*5) + (textDescargos.length*5) + (textProc.length*5) + (textAdv.length*5) + 35;
        ensureSpace(blockHeight);

        docPDF.setTextColor(0,0,0);
        docPDF.setFont("helvetica","bold");
        docPDF.setFontSize(11);
        docPDF.text(`Anotaci√≥n n√∫mero ${numTxt}`, 14, y); y += 6;

        docPDF.setFont("helvetica","normal");
        docPDF.setFontSize(9);
        docPDF.text(`Fecha: ${r.fecha || "Sin fecha"} | Tipo: ${r.tipoRegistro || "N/A"}`, 14, y); y += 6;

        docPDF.text(textComportamiento, 14, y); y += (textComportamiento.length * 5);
        if (textDescargos.length) { docPDF.text(textDescargos, 14, y); y += (textDescargos.length * 5); }
        if (textProc.length) { docPDF.text(textProc, 14, y); y += (textProc.length * 5); }
        y += 2;

        let advColor = [200, 0, 0];
        if (index === 0) advColor = [22, 101, 52];
        else if (index === 1) advColor = [154, 52, 18];

        docPDF.setFont("helvetica","bold");
        docPDF.setTextColor(...advColor);
        docPDF.text(textAdv, 14, y); y += (textAdv.length * 5);

        docPDF.setTextColor(0,0,0);
        docPDF.setFont("helvetica","normal");
        y += 5;

        const sigH = 12;
        try { if (r.firmaEstudiante) docPDF.addImage(r.firmaEstudiante, 'PNG', 15, y, 35, sigH); } catch(e){}
        try { if (r.firmaDocente) docPDF.addImage(r.firmaDocente, 'PNG', 82, y, 35, sigH); } catch(e){}
        try { if (r.firmaAcudiente) docPDF.addImage(r.firmaAcudiente, 'PNG', 150, y, 35, sigH); } catch(e){}

        y += sigH + 3;
        docPDF.setFontSize(7);
        docPDF.text("Firma Estudiante", 32, y, {align:"center"});
        docPDF.text("Firma Docente", 100, y, {align:"center"});
        docPDF.text("Firma Acudiente", 167, y, {align:"center"});

        y += 8;
        docPDF.setDrawColor(220);
        docPDF.line(14, y, 196, y);
        y += 10;
      });

      if (idxCiclo < ciclos.length - 1) {
        ensureSpace(10);
        docPDF.setTextColor(120);
        docPDF.setFontSize(8);
        docPDF.text("‚Äî Fin de ciclo ‚Äî", 105, y, {align:"center"});
        y += 10;
      }
    });

    docPDF.save(`Seguimiento_${nombreEst}_TODOS_LOS_CICLOS.pdf`);
  };

  // ------- Render historial obs -------
  function iniciarEscuchasObs() {
    onSnapshot(query(collection(db, "registrosComportamentales"), orderBy("timestamp", "desc")), (snap) => {
      localRegistrosObs = [];
      snap.forEach(d => localRegistrosObs.push({ id: d.id, ...d.data() }));
      renderRegistrosObs(localRegistrosObs);
    });
  }

  function renderRegistrosObs(data) {
    const list = document.getElementById('listaRegistros');
    if (!list) return;

    list.innerHTML = data.map(r => `
      <div class="obs-list-card" style="${(r.ciclo > 1) ? 'border-left-color: #f57c00;' : ''}">
        <div class="excusa-header">
          <b class="card-name">üë§ ${r.nombreEstudiante || ''}</b>
          <span class="card-date" style="background:#e8f5e9">${r.fecha || ''} (Ciclo #${r.ciclo || 1})</span>
        </div>
        <div class="sigs-history-row">
          <div class="sig-view-box"><span>Estud.</span>${r.firmaEstudiante ? `<img src="${r.firmaEstudiante}" class="sig-img-history">` : 'N/A'}</div>
          <div class="sig-view-box"><span>Docen.</span>${r.firmaDocente ? `<img src="${r.firmaDocente}" class="sig-img-history">` : 'N/A'}</div>
          <div class="sig-view-box"><span>Acud.</span>${r.firmaAcudiente ? `<img src="${r.firmaAcudiente}" class="sig-img-history">` : 'Pte'}</div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn-mini btn-pdf-obs" onclick="window.descargarPDFIndividual('${r.id}')">üìÑ Individual</button>
          <button class="btn-mini btn-edit-obs" onclick="window.cargarParaEditarObs('${r.id}')">‚úèÔ∏è</button>
          <button class="btn-mini btn-del" onclick="window.openDeleteModal('${r.id}','registrosComportamentales')">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  window.filtrarHistorialObs = () => {
    const queryTxt = (document.getElementById('searchHistoryInput').value || "").toLowerCase();
    const filtrados = localRegistrosObs.filter(r =>
      (r.nombreEstudiante || "").toLowerCase().includes(queryTxt) ||
      (r.comportamiento || "").toLowerCase().includes(queryTxt)
    );
    renderRegistrosObs(filtrados);
  };

  // ------- Editar obs -------
  window.cargarParaEditarObs = (id) => {
    const r = localRegistrosObs.find(x => x.id === id); if(!r) return;
    document.getElementById('editObsId').value = r.id;
    document.getElementById('tipoRegistro').value = r.tipoRegistro || "Comportamental";
    document.getElementById('fecha').value = r.fecha || "";
    document.getElementById('selectEstudianteObs').value = r.documentoEstudiante || "";
    document.getElementById('comportamiento').value = r.comportamiento || "";
    document.getElementById('descargos').value = r.descargos || "";
    document.getElementById('procedimiento').value = r.procedimiento || "";
    document.getElementById('btnSubmitObs').innerText = "ACTUALIZAR REGISTRO";
    window.scrollTo({top: 0, behavior:'smooth'});
  };

  // ------- Guardar obs -------
  document.getElementById('formRegistro').onsubmit = async (e) => {
    e.preventDefault();

    const pE = pads.get('sigStudent');
    const pT = pads.get('sigTeacher');

    const selectE = document.getElementById('selectEstudianteObs');
    const studentName = selectE.options[selectE.selectedIndex]?.text || "";
    const studentDoc = selectE.value;

    if(!studentDoc) return alert("Seleccione un estudiante.");
    if(!pE?.hasData || !pT?.hasData) return alert("Firme ambas casillas.");

    const ciclo = await getCicloActual(studentDoc);
    const editId = document.getElementById('editObsId').value;

    if (!editId) {
      const obsEnCiclo = localRegistrosObs.filter(r => r.documentoEstudiante === studentDoc && (r.ciclo || 1) === ciclo).length;
      if (obsEnCiclo < 3) alert(ADVERTENCIAS[obsEnCiclo]);
    }

    const data = {
      tipoRegistro: document.getElementById('tipoRegistro').value,
      fecha: document.getElementById('fecha').value,
      nombreEstudiante: studentName,
      documentoEstudiante: studentDoc,
      comportamiento: document.getElementById('comportamiento').value,
      descargos: document.getElementById('descargos').value,
      procedimiento: document.getElementById('procedimiento').value,
      timestamp: new Date().toISOString(),
      firmaEstudiante: pE.canvas.toDataURL(),
      firmaDocente: pT.canvas.toDataURL(),
      ciclo
    };

    if (editId) await updateDoc(doc(db, "registrosComportamentales", editId), data);
    else await addDoc(collection(db, "registrosComportamentales"), data);

    alert("‚úÖ Registro guardado.");
    e.target.reset();
    document.getElementById('editObsId').value = "";
    document.getElementById('btnSubmitObs').innerText = "ENVIAR REGISTRO";
    window.limpiarPad('sigStudent');
    window.limpiarPad('sigTeacher');
  };

  // ------- Correspondencia -------
  function cargarCorrespondencia() {
    onSnapshot(query(collection(db, "comunicacionPadres"), orderBy("timestamp", "desc")), (snap) => {
      let html = '';
      snap.forEach(d => {
        const m = d.data();
        const id = d.id;
        html += `
          <div class="excusa-card" style="border-left-color: var(--corr-color);">
            <strong>üë§ ${m.nombreEstudiante || 'Estudiante'}</strong>
            <div style="font-size:13px; margin:8px 0;">${m.mensaje || ''}</div>
            ${m.respuestaDocente
              ? `<div style="color:green; font-size:12px;"><b>Resp:</b> ${m.respuestaDocente}</div>`
              : `<textarea id="rep_txt_${id}" placeholder="Escriba la respuesta..."></textarea>
                 <button class="btn-mini" style="background: var(--corr-color); color:#fff;" onclick="responderMsg('${id}')">Responder</button>`
            }
          </div>
        `;
      });
      document.getElementById('listaCorrespondencia').innerHTML = html || 'Sin mensajes.';
    });
  }

  window.responderMsg = async (id) => {
    const txt = (document.getElementById(`rep_txt_${id}`)?.value || "").trim();
    if (!txt) return alert("Escriba una respuesta.");
    try {
      await updateDoc(doc(db, "comunicacionPadres", id), {
        respuestaDocente: txt,
        respuestaTimestamp: new Date().toISOString()
      });
      alert("‚úÖ Respuesta enviada.");
    } catch (e) {
      alert("‚ùå No se pudo enviar la respuesta.");
    }
  };

  // ------- Modal delete -------
  window.openDeleteModal = (id, col) => { currentDeleteInfo = { id, collection: col }; document.getElementById('deleteModal').style.display = 'flex'; };
  window.closeDeleteModal = () => { document.getElementById('deleteModal').style.display = 'none'; };
  document.getElementById('confirmDeleteBtn').onclick = async () => {
    await deleteDoc(doc(db, currentDeleteInfo.collection, currentDeleteInfo.id));
    window.closeDeleteModal();
  };

  // ------- Onload -------
  window.onload = async () => {
    document.getElementById('fechaAsistencia').valueAsDate = new Date();
    document.getElementById('fecha').valueAsDate = new Date();

    const selectObs = document.getElementById('selectEstudianteObs');
    estudiantesBase.forEach(est => {
      const opt = document.createElement('option');
      opt.value = est.doc; opt.textContent = est.nombre;
      selectObs.appendChild(opt);
    });

    await cargarConfiguracionPeriodo();
    escucharAsistencia();
    iniciarEscuchasObs();

    onSnapshot(collection(db, "excusasInasistencia"), (snap) => {
      localExcusas = [];
      snap.forEach(d => localExcusas.push({ id: d.id, ...d.data() }));
      window.filtrarExcusas();
    });

    const st = document.getElementById('connStatus');
    st.className = navigator.onLine ? 'conn-indicator conn-online' : 'conn-indicator conn-offline';

    window.cargarAsistenciaDelDia();
  };

  window.toggleHistorial = (id) => {
    const el = document.getElementById(id);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
  };
</script>
</body>
</html>
