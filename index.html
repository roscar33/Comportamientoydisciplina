<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro Comportamental - Docente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --primary: #22c55e;
      --primary-dark: #15803d;
      --accent: #0ea5e9;
      --bg: #e8f5e9;
      --card-bg: #ffffff;
      --border: #cbd5e1;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 30px rgba(15,23,42,0.12);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #bbf7d0, #f9fafb 55%);
      min-height: 100vh;
      padding: 16px;
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 1100px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 52px;
      height: 52px;
      border-radius: 999px;
      overflow: hidden;
      flex-shrink: 0;
      border: 2px solid #22c55e33;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #064e3b;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .connection-status {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .connection-status.online {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #4ade80;
    }

    .connection-status.offline {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      body { padding: 10px; }
      .layout { grid-template-columns: minmax(0, 1fr); }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 8px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #064e3b;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #15803d;
      border: 1px solid #bbf7d0;
      white-space: nowrap;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 700px) {
      .form-grid { grid-template-columns: minmax(0, 1fr); }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      color: #0f172a;
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
      font-size: 13px;
      color: var(--text-main);
      outline: none;
      transition: border 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: #94a3b8;
    }

    input:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
      background: #ffffff;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .signature-block {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .signature-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    canvas {
      border-radius: 14px;
      border: 1px dashed #cbd5e1;
      background: #ffffff;
      width: 100%;
      height: 240px;
      display: block;
      cursor: crosshair;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      border: none;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      padding: 8px 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }

    button:active { transform: scale(0.97); }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #ecfdf5;
      box-shadow: 0 10px 20px rgba(22,163,74,0.35);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #0ea5e9, #0369a1);
      color: #e0f2fe;
      box-shadow: 0 10px 20px rgba(56,189,248,0.35);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color: #fee2e2;
      box-shadow: 0 10px 20px rgba(248,113,113,0.35);
    }

    .records-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .search-input {
      flex: 1;
      min-width: 0;
    }

    .search-input input { width: 100%; }

    .records-list {
      max-height: 70vh;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #ffffff;
    }

    .records-list::-webkit-scrollbar { width: 6px; }
    .records-list::-webkit-scrollbar-track { background: #ffffff; }
    .records-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 999px;
    }

    .student-card {
      background: #f9fafb;
      border-radius: var(--radius-md);
      border: 1px solid #e2e8f0;
      margin-bottom: 12px;
      padding: 10px 10px 8px;
    }

    .student-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .student-name {
      font-size: 14px;
      font-weight: 600;
      color: #022c22;
    }

    .student-doc {
      font-size: 12px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }

    th, td {
      border: 1px solid #e2e8f0;
      padding: 6px 6px;
      vertical-align: top;
      text-align: left;
    }

    th {
      background: #ecfdf3;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #166534;
    }

    tbody tr:nth-child(even) { background: #f9fafb; }
    tbody tr:nth-child(odd) { background: #ffffff; }

    .signature-cell { text-align: center; }

    .signature-cell img {
      max-width: 140px;
      max-height: 60px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
    }

    .badge-pendiente,
    .badge-firmado {
      display: inline-flex;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-pendiente {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .badge-firmado {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #4ade80;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: stretch;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 999px;
      justify-content: center;
    }

    .btn-edit {
      background: #e0f2fe;
      color: #075985;
      border: 1px solid #bae6fd;
    }

    .btn-delete {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .no-records {
      text-align: center;
      padding: 16px 8px;
      font-size: 13px;
      color: var(--text-muted);
      border-radius: var(--radius-md);
      border: 1px dashed #cbd5e1;
      background: #f9fafb;
      margin-top: 8px;
    }

    @media (max-width: 600px) {
      body { padding: 10px; }
      .card { padding: 16px 14px 14px; }
      canvas { height: 220px; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="top-bar">
      <div class="brand">
        <!-- guarda tu escudo como escudo.png en la misma carpeta -->
        <div class="brand-logo">
          <img src="escudo.png" alt="Escudo Institución Educativa de María">
        </div>
        <div class="brand-text">
          <div class="brand-title">Institución Educativa de María</div>
          <div class="brand-subtitle">Sede Rural Santa Juana · Seguimiento comportamental 2026</div>
        </div>
      </div>
      <div id="connStatus" class="connection-status offline">
        <span class="connection-dot"></span><span>Offline</span>
      </div>
    </header>

    <main class="layout">
      <!-- Columna izquierda: formulario -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Registro del docente</div>
            <div class="card-subtitle">Diligencie los campos y la firma del estudiante / docente.</div>
          </div>
          <div class="pill">Uso interno del docente</div>
        </div>

        <form id="registroForm">
          <input type="hidden" id="firebaseId" />

          <div class="form-grid">
            <div class="form-group">
              <label for="fecha">Fecha</label>
              <input type="date" id="fecha" required />
            </div>

            <div class="form-group">
              <label for="documentoEstudiante">Documento del estudiante</label>
              <input type="text" id="documentoEstudiante" required placeholder="Ej: 123456789" />
            </div>

            <div class="form-group">
              <label for="nombreEstudiante">Nombre del estudiante</label>
              <input type="text" id="nombreEstudiante" required placeholder="Nombre completo" />
            </div>

            <div class="form-group"></div>
          </div>

          <div class="form-group" style="margin-top:10px;">
            <label for="comportamiento">Descripción del comportamiento</label>
            <textarea id="comportamiento" required placeholder="Explique brevemente la situación presentada..."></textarea>
          </div>

          <div class="form-group">
            <label for="descargos">Descargos (versión del estudiante)</label>
            <textarea id="descargos" required placeholder="Registre lo manifestado por el estudiante..."></textarea>
          </div>

          <div class="form-group">
            <label for="procedimiento">Procedimiento / acciones a seguir</label>
            <textarea id="procedimiento" required placeholder="Compromisos, acuerdos, remisiones, etc."></textarea>
          </div>

          <div class="signature-block">
            <div class="signature-label-row">
              <span>Firma estudiante / docente</span>
              <span class="field-hint">Use el dedo o el cursor para firmar</span>
            </div>
            <canvas id="signaturePad"></canvas>
            <div class="button-row">
              <button type="button" class="btn-danger" id="btnLimpiarFirma">Limpiar firma</button>
            </div>
          </div>

          <div class="button-row" style="margin-top:14px;">
            <button type="submit" class="btn-primary" id="submitBtn">Guardar registro</button>
            <button type="button" class="btn-secondary" id="cancelBtn" style="display:none;">Cancelar edición</button>
          </div>
        </form>
      </section>

      <!-- Columna derecha: registros -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Registros por estudiante</div>
            <div class="card-subtitle">Visualice anotaciones y el estado de firma del acudiente.</div>
          </div>
        </div>

        <div class="records-header-row">
          <div class="search-input">
            <input
              type="text"
              id="searchInput"
              placeholder="Buscar por nombre del estudiante..."
            />
          </div>
          <span class="pill">Actualización en tiempo real</span>
        </div>

        <div id="recordsList" class="records-list"></div>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc,
      doc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
      authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
      projectId: "diariodeprocesos-6f78d",
      storageBucket: "diariodeprocesos-6f78d.firebasestorage.app",
      messagingSenderId: "487922338632",
      appId: "1:487922338632:web:47fc48c23dbea064b0817d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const registrosCol = collection(db, "registrosComportamentales");

    const connStatus = document.getElementById('connStatus');
    function updateConn() {
      if (navigator.onLine) {
        connStatus.className = "connection-status online";
        connStatus.innerHTML = '<span class="connection-dot"></span><span>Online - Conectado</span>';
      } else {
        connStatus.className = "connection-status offline";
        connStatus.innerHTML = '<span class="connection-dot"></span><span>Offline (requiere internet)</span>';
      }
    }
    window.addEventListener('online', updateConn);
    window.addEventListener('offline', updateConn);
    updateConn();

    const canvas = document.getElementById('signaturePad');
    const ctx = canvas.getContext('2d');

    function ajustarCanvas() {
      const w = canvas.getBoundingClientRect().width || 500;
      canvas.width = w;
      canvas.height = 240;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    ajustarCanvas();
    window.addEventListener('resize', ajustarCanvas);

    let isDrawing = false, lastX = 0, lastY = 0;
    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      let x, y;
      if (e.touches && e.touches[0]) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.offsetX ?? (e.clientX - rect.left);
        y = e.offsetY ?? (e.clientY - rect.top);
      }
      return { x, y };
    }
    function startDrawing(e) {
      e.preventDefault();
      isDrawing = true;
      const p = getPos(e);
      lastX = p.x;
      lastY = p.y;
    }
    function draw(e) {
      if (!isDrawing) return;
      e.preventDefault();
      const p = getPos(e);
      ctx.strokeStyle = "#0f172a";
      ctx.lineWidth = 2.2;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      lastX = p.x;
      lastY = p.y;
    }
    function stopDrawing(e) {
      e && e.preventDefault();
      isDrawing = false;
    }

    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mouseout", stopDrawing);
    canvas.addEventListener("touchstart", startDrawing, { passive:false });
    canvas.addEventListener("touchmove", draw, { passive:false });
    canvas.addEventListener("touchend", stopDrawing, { passive:false });

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    document.getElementById('btnLimpiarFirma').addEventListener('click', clearSignature);

    const registroForm = document.getElementById('registroForm');
    const firebaseIdInput = document.getElementById('firebaseId');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const recordsList = document.getElementById('recordsList');
    const searchInput = document.getElementById('searchInput');

    let registros = [];

    function escapeHTML(s) {
      if (!s) return "";
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function agruparPorEstudiante(lista) {
      const g = {};
      lista.forEach(r => {
        const nombre = r.nombreEstudiante || "Sin nombre";
        if (!g[nombre]) g[nombre] = [];
        g[nombre].push(r);
      });
      return g;
    }

    function mostrarRegistros(lista) {
      if (!lista || lista.length === 0) {
        recordsList.innerHTML = '<div class="no-records">No hay registros almacenados.</div>';
        return;
      }

      const grouped = agruparPorEstudiante(lista);
      let html = "";
      Object.keys(grouped).sort().forEach(nombre => {
        const rs = grouped[nombre];
        const docRef = rs[0]?.documentoEstudiante || "";
        html += '<article class="student-card">';
        html += ' <header class="student-card-header">';
        html += '   <div>';
        html += '     <div class="student-name">' + escapeHTML(nombre) + '</div>';
        html += '     <div class="student-doc">Documento: ' + escapeHTML(docRef) + '</div>';
        html += '   </div>';
        html += ' </header>';
        html += '  <table>';
        html += '    <thead><tr>';
        html += '      <th>Fecha</th>';
        html += '      <th>Comportamiento</th>';
        html += '      <th>Descargos</th>';
        html += '      <th>Procedimiento</th>';
        html += '      <th>Firma estudiante</th>';
        html += '      <th>Firma acudiente</th>';
        html += '      <th>Acciones</th>';
        html += '    </tr></thead>';
        html += '    <tbody>';

        rs.forEach(r => {
          html += '<tr>';
          html += '<td>' + escapeHTML(r.fecha || "") + '</td>';
          html += '<td>' + escapeHTML(r.comportamiento || "") + '</td>';
          html += '<td>' + escapeHTML(r.descargos || "") + '</td>';
          html += '<td>' + escapeHTML(r.procedimiento || "") + '</td>';

          html += '<td class="signature-cell">';
          if (r.firma) html += '<img src="' + r.firma + '" alt="Firma estudiante">';
          else html += '<span class="badge-pendiente">Sin firma</span>';
          html += '</td>';

          html += '<td class="signature-cell">';
          if (r.firmaAcudiente) {
            html += '<div style="display:flex;flex-direction:column;align-items:center;gap:4px;">';
            html += '<img src="' + r.firmaAcudiente + '" alt="Firma acudiente">';
            if (r.fechaFirmaAcudiente) {
              html += '<span style="font-size:10px;color:#64748b;">' +
                      escapeHTML(r.fechaFirmaAcudiente) + '</span>';
            }
            html += '<span class="badge-firmado">Firmado</span>';
            html += '</div>';
          } else {
            html += '<span class="badge-pendiente">Pendiente</span>';
          }
          html += '</td>';

          html += '<td>';
          html += '  <div class="action-buttons">';
          html += '    <button class="btn-small btn-edit" onclick="editRecord(\'' + r.firebaseId + '\')">Editar</button>';
          html += '    <button class="btn-small btn-delete" onclick="deleteRecord(\'' + r.firebaseId + '\')">Eliminar</button>';
          html += '  </div>';
          html += '</td>';

          html += '</tr>';
        });

        html += '    </tbody>';
        html += '   </table>';
        html += '</article>';
      });

      recordsList.innerHTML = html;
    }

    function filtrarYMostrar() {
      const term = (searchInput.value || "").toLowerCase();
      if (!term) {
        mostrarRegistros(registros);
      } else {
        mostrarRegistros(
          registros.filter(r => (r.nombreEstudiante || "").toLowerCase().includes(term))
        );
      }
    }
    searchInput.addEventListener('input', filtrarYMostrar);

    onSnapshot(registrosCol, snapshot => {
      registros = snapshot.docs.map(d => ({
        firebaseId: d.id,
        ...d.data()
      }));
      filtrarYMostrar();
    });

    registroForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!navigator.onLine) {
        alert("Se necesita conexión a internet para guardar.");
        return;
      }

      const id = firebaseIdInput.value || null;
      const baseData = {
        fecha: document.getElementById('fecha').value,
        nombreEstudiante: document.getElementById('nombreEstudiante').value,
        documentoEstudiante: document.getElementById('documentoEstudiante').value,
        comportamiento: document.getElementById('comportamiento').value,
        descargos: document.getElementById('descargos').value,
        procedimiento: document.getElementById('procedimiento').value,
        firma: canvas.toDataURL("image/png")
      };

      try {
        if (id) {
          // conservar firmaAcudiente si ya existía
          const existente = registros.find(r => r.firebaseId === id) || {};
          const data = {
            ...baseData,
            firmaAcudiente: existente.firmaAcudiente ?? null,
            fechaFirmaAcudiente: existente.fechaFirmaAcudiente ?? null
          };
          await updateDoc(doc(db, "registrosComportamentales", id), data);
          alert("Registro actualizado.");
        } else {
          const data = {
            ...baseData,
            firmaAcudiente: null,
            fechaFirmaAcudiente: null
          };
          await addDoc(registrosCol, data);
          alert("Registro creado.");
        }
        limpiarFormulario();
      } catch (err) {
        console.error(err);
        alert("Error al guardar. Revisa la consola del navegador.");
      }
    });

    function limpiarFormulario() {
      registroForm.reset();
      firebaseIdInput.value = "";
      submitBtn.textContent = "Guardar registro";
      cancelBtn.style.display = "none";
      clearSignature();
      document.getElementById('fecha').valueAsDate = new Date();
    }
    cancelBtn.addEventListener('click', limpiarFormulario);

    window.editRecord = function(id) {
      const r = registros.find(x => x.firebaseId === id);
      if (!r) return;
      firebaseIdInput.value = r.firebaseId;
      document.getElementById('fecha').value = r.fecha || "";
      document.getElementById('nombreEstudiante').value = r.nombreEstudiante || "";
      document.getElementById('documentoEstudiante').value = r.documentoEstudiante || "";
      document.getElementById('comportamiento').value = r.comportamiento || "";
      document.getElementById('descargos').value = r.descargos || "";
      document.getElementById('procedimiento').value = r.procedimiento || "";
      clearSignature();
      if (r.firma) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = r.firma;
      }
      submitBtn.textContent = "Actualizar registro";
      cancelBtn.style.display = "inline-flex";
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    window.deleteRecord = async function(id) {
      if (!confirm("¿Eliminar este registro?")) return;
      if (!navigator.onLine) {
        alert("Se necesita conexión a internet para eliminar.");
        return;
      }
      try {
        await deleteDoc(doc(db, "registrosComportamentales", id));
        alert("Registro eliminado.");
      } catch (err) {
        console.error(err);
        alert("Error al eliminar.");
      }
    };

    document.getElementById('fecha').valueAsDate = new Date();
  </script>
</body>
</html>
