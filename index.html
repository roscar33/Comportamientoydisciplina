<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Seguimiento Disciplinario - Docente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Librer√≠as para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #1b5e20;       
      --primary-light: #2e7d32; 
      --accent: #0288d1;        
      --bg-body: #c8e6c9;       
      --text-main: #0f172a;
      --text-muted: #555;
      --card-bg: #ffffff;
      --border: #dcdcdc;
      --radius-xl: 24px;
      --radius-md: 12px;
      --shadow: 0 4px 15px rgba(27, 94, 32, 0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-body);
      min-height: 100vh;
      padding: 16px;
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 20px; }

    /* ENCABEZADO */
    .top-bar {
      display: flex; align-items: center; gap: 15px; padding: 12px 20px;
      background: #ffffff; border-radius: 50px; box-shadow: var(--shadow); border: 1px solid #c8e6c9;
    }
    .brand-logo { width: 55px; height: 55px; flex-shrink: 0; }
    .brand-logo img { width: 100%; height: 100%; object-fit: contain; }
    .brand-text { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .brand-title { font-size: 16px; font-weight: 800; color: var(--primary); line-height: 1.2; }
    .brand-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    .conn-pill {
      font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px;
      white-space: nowrap; display: flex; align-items: center; gap: 5px; border: 1px solid transparent;
    }
    .conn-online { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
    .conn-offline { background: #ffebee; color: #c62828; border-color: #ef9a9a; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

    /* TABS */
    .nav-tabs {
      display: flex; background: #fff; padding: 5px; border-radius: 50px; box-shadow: var(--shadow); margin-bottom: 10px;
    }
    .nav-btn {
      flex: 1; border: none; background: transparent; padding: 12px; border-radius: 40px;
      font-weight: 700; color: #666; cursor: pointer; transition: all 0.3s ease;
    }
    .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(27, 94, 32, 0.3); }

    /* TARJETAS */
    .card {
      background: var(--card-bg); border-radius: var(--radius-xl); padding: 24px;
      box-shadow: var(--shadow); border: 1px solid white; position: relative; margin-bottom: 20px;
    }
    .card-title { font-size: 18px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
    .card-desc { font-size: 13px; color: var(--text-muted); line-height: 1.4; }

    /* FORMULARIO */
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 900px) { .form-grid.top-row { grid-template-columns: 1fr 1fr 2fr; } }

    .form-group { margin-bottom: 12px; position: relative; }
    label { display: block; font-size: 13px; font-weight: 700; color: #333; margin-bottom: 6px; }
    input, textarea, select {
      width: 100%; padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid #ccc;
      background: #fafafa; font-size: 14px; transition: all 0.2s;
    }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1); }
    textarea { min-height: 100px; resize: vertical; }

    /* BUSCADOR CON LUPA */
    .search-wrapper { position: relative; }
    .search-wrapper input { padding-left: 35px; }
    .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 16px; opacity: 0.5; }

    /* BOTONES */
    .btn-row { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    button {
      border: none; padding: 12px 20px; border-radius: 30px; font-size: 14px; font-weight: 700;
      cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); }

    .btn-save { background: var(--primary); color: white; flex: 2; box-shadow: 0 4px 10px rgba(27, 94, 32, 0.3); }
    .btn-clear { background: #d32f2f; color: white; flex: 1; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3); }
    .btn-historial { background: #455a64; color: white; width: 100%; margin-top: 10px; box-shadow: 0 4px 10px rgba(69, 90, 100, 0.3); }
    .btn-blue { background: #0288d1; color: white; font-size: 12px; padding: 8px 16px; }
    .btn-icon { padding: 6px 10px; font-size: 12px; border-radius: 8px; }
    .btn-del { background: #ffebee; color: #c62828; }
    .btn-edit { background: #f1f8e9; color: #33691e; }
    .bg-gray { background: #eee; color: #333; }

    /* SECCIONES OCULTAS (ACORDE√ìN) */
    .hidden-section { display: none; margin-top: 20px; border-top: 2px dashed #ddd; padding-top: 20px; animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* TABLAS */
    .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid #ddd; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; background: #fff; }
    th { background: var(--primary); color: white; text-align: left; padding: 12px; font-weight: 600; white-space: nowrap; }
    td { padding: 12px; border-bottom: 1px solid #eee; color: #333; vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    .sig-preview { max-width: 80px; height: auto; border: 1px solid #eee; border-radius: 4px; padding: 2px; }

    /* CANVAS FIRMA */
    canvas.signature-pad { width: 100%; height: 180px; background: #fff; border: 2px dashed #b0bec5; border-radius: var(--radius-md); cursor: crosshair; touch-action: none; }

    /* ASISTENCIA */
    .attendance-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
    .att-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; }
    .att-name { font-weight: 600; font-size: 14px; color: #334155; }
    .att-options { display: flex; gap: 5px; }
    .att-btn { border: 1px solid #cbd5e1; background: #fff; color: #64748b; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .att-btn.active-p { background: #dcfce7; color: #166534; border-color: #86efac; }
    .att-btn.active-e { background: #ffedd5; color: #9a3412; border-color: #fdba74; }
    .att-btn.active-i { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }

    /* ESTUDIANTE BLOQUE HISTORIAL */
    .student-block { border: 1px solid #e0e0e0; border-radius: var(--radius-md); margin-bottom: 15px; overflow: hidden; }
    .student-info-bar { background: #f5f5f5; padding: 10px 15px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    
    @media(max-width: 600px) {
      .top-bar { flex-direction: column; align-items: flex-start; border-radius: 20px; }
      .btn-row { flex-direction: column; }
      button { width: 100%; }
      .att-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      .att-options { width: 100%; justify-content: space-between; }
      .att-btn { flex: 1; text-align: center; }
    }
  </style>
</head>
<body>

<div class="app-shell">
  
  <header class="top-bar">
    <div class="brand-logo">
      <img src="escudo.png" alt="Escudo" onerror="this.src='https://placehold.co/100x100/1b5e20/ffffff?text=IE';">
    </div>
    <div class="brand-text">
      <div class="brand-title">Instituci√≥n Educativa de Mar√≠a</div>
      <div class="brand-subtitle">Sede Rural Santa Juana (Primaria) ¬∑ 2026</div>
      <div class="brand-subtitle" style="font-weight:600;">Seguimiento comportamental y disciplinario</div>
    </div>
    <div id="connStatus" class="conn-pill conn-offline">
      <div class="dot"></div> <span>Conectando...</span>
    </div>
  </header>

  <!-- MEN√ö TABS -->
  <nav class="nav-tabs">
    <button id="btnTabObs" class="nav-btn active" onclick="switchTab('obs')">Observaciones y Disciplina</button>
    <button id="btnTabAsis" class="nav-btn" onclick="switchTab('asis')">Control de Asistencia</button>
  </nav>

  <!-- VISTA 1: OBSERVACIONES -->
  <div id="view-obs">
      <section class="card">
        <h2 class="card-title">üìù Nuevo Registro</h2>
        <p class="card-desc">Observaciones comportamentales y acad√©micas.</p>

        <form id="formRegistro">
          <input type="hidden" id="editId">

          <div class="form-grid top-row">
            <div class="form-group">
                <label style="color:#d84315;">Tipo de registro</label>
                <select id="tipoRegistro" style="font-weight:bold; color:#d84315;">
                    <option value="Comportamental">Comportamental</option>
                    <option value="Acad√©mico">Acad√©mico</option>
                </select>
            </div>

            <div class="form-group">
              <label>Fecha</label>
              <input type="date" id="fecha" required>
            </div>

            <!-- BUSCADOR CON LUPA -->
            <div class="form-group">
              <label>Buscar Estudiante</label>
              <div class="search-wrapper">
                  <span class="search-icon">üîç</span>
                  <input list="listaEstudiantes" id="inputEstudiante" placeholder="Escriba nombre del estudiante..." required>
                  <datalist id="listaEstudiantes"></datalist>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Descripci√≥n del comportamiento / Novedad</label>
            <textarea id="comportamiento" placeholder="Explique la situaci√≥n presentada..."></textarea>
          </div>

          <div class="form-grid">
            <div class="form-group">
                <label>Descargos (versi√≥n del estudiante)</label>
                <textarea id="descargos" placeholder="Lo que manifiesta el estudiante..."></textarea>
            </div>
            <div class="form-group">
                <label>Procedimiento / acciones a seguir</label>
                <textarea id="procedimiento" placeholder="Compromisos o sanciones..."></textarea>
            </div>
          </div>

          <div class="form-group">
            <label>Firma estudiante / docente</label>
            <canvas id="signaturePad" class="signature-pad"></canvas>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-clear" id="btnLimpiar">Limpiar firma</button>
            <button type="submit" class="btn-save" id="btnGuardar">Guardar registro</button>
          </div>
          <div style="margin-top:10px; display:none;" id="divCancel">
             <button type="button" class="bg-gray btn-icon" style="width:100%" onclick="cancelarEdicion()">Cancelar Edici√≥n</button>
          </div>

          <!-- BOT√ìN PARA VER HISTORIAL -->
          <button type="button" class="btn-historial" onclick="toggleHistorial('historialObs')">üìÇ Ver Historial de Registros</button>
        </form>

        <!-- SECCI√ìN OCULTA: HISTORIAL -->
        <div id="historialObs" class="hidden-section">
            <h3 style="color:#1b5e20; border-bottom:1px solid #ddd; padding-bottom:5px;">Historial Completo</h3>
            <div class="form-group">
                <input type="text" id="buscador" placeholder="üîç Buscar registro antiguo..." onkeyup="renderRegistros()">
            </div>
            <div id="listaRegistros">
                <div style="text-align:center; padding:20px; color:#888;">Cargando datos...</div>
            </div>
        </div>
      </section>
  </div>

  <!-- VISTA 2: ASISTENCIA -->
  <div id="view-asis" style="display:none;">
      
      <section class="card" style="border-left: 5px solid #0288d1;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 class="card-title" style="color:#0288d1; margin:0;">Asistencia Diaria</h2>
            <input type="date" id="fechaAsistencia" style="padding:8px; border-radius:8px; border:1px solid #ccc;" onchange="cargarAsistenciaDelDia()">
        </div>

        <div id="attendanceList" class="attendance-grid">
            <div style="text-align:center; color:#888;">Cargando lista...</div>
        </div>

        <div class="btn-row" style="margin-top:20px;">
            <button class="btn-blue" onclick="guardarAsistencia()">üíæ Guardar Asistencia</button>
        </div>

        <div class="section-divider">Reportes</div>
        <div style="display:flex; gap:10px; align-items:center; background:#f1f9ff; padding:10px; border-radius:12px;">
            <input type="month" id="mesReporte" style="flex:1;">
            <button class="btn-icon bg-gray" onclick="descargarReporteMensual()">üìä Descargar Matriz</button>
        </div>

        <!-- BOT√ìN PARA VER EXCUSAS -->
        <button type="button" class="btn-historial" style="background:#0288d1;" onclick="toggleHistorial('historialExc')">üì© Ver Historial de Excusas</button>

        <!-- SECCI√ìN OCULTA: HISTORIAL EXCUSAS -->
        <div id="historialExc" class="hidden-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="color:#0288d1; margin:0;">Excusas Recibidas</h3>
                <button class="btn-icon bg-gray" onclick="descargarExcusasPDF()">üìÑ PDF</button>
            </div>
            <div id="listaExcusas">
                <div style="text-align:center; padding:20px; color:#888;">Cargando excusas...</div>
            </div>
        </div>
      </section>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, 
    onSnapshot, setDoc, getDoc, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
    authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
    projectId: "diariodeprocesos-6f78d",
    storageBucket: "diariodeprocesos-6f78d.firebasestorage.app",
    messagingSenderId: "487922338632",
    appId: "1:487922338632:web:47fc48c23dbea064b0817d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- LISTA DE ESTUDIANTES ---
  const estudiantesBase = [
    { doc: "1157463842", nombre: "BERRIO CORREA VALENTINA" },
    { doc: "1038213324", nombre: "GUZMAN CORREA DYLAN" },
    { doc: "1072263423", nombre: "MEDINA POLO JESUS DAVID" },
    { doc: "1041636093", nombre: "MEJIA VALLEJO TOMAS" },
    { doc: "1041636021", nombre: "VARELAS BARRIENTOS MAXIMILIANO" }
  ];

  // Llenar datalist para buscador con lupa
  const dataList = document.getElementById("listaEstudiantes");
  estudiantesBase.forEach(est => {
      const option = document.createElement("option");
      option.value = est.nombre; // Valor visible es el nombre
      option.setAttribute("data-doc", est.doc); // Guardamos doc como atributo
      dataList.appendChild(option);
  });

  // --- ESTADO ---
  let allRegistros = [];
  let allExcusas = [];
  let asistenciaTemp = {};

  const updateStatus = (online) => {
    const el = document.getElementById('connStatus');
    if(online) { el.className='conn-pill conn-online'; el.innerHTML='<div class="dot"></div> Online'; }
    else { el.className='conn-pill conn-offline'; el.innerHTML='<div class="dot"></div> Offline'; }
  };
  window.addEventListener('online', () => updateStatus(true));
  window.addEventListener('offline', () => updateStatus(false));
  updateStatus(navigator.onLine);

  // --- NAVEGACI√ìN ---
  window.switchTab = (tab) => {
      document.getElementById('view-obs').style.display = tab === 'obs' ? 'block' : 'none';
      document.getElementById('view-asis').style.display = tab === 'asis' ? 'block' : 'none';
      document.getElementById('btnTabObs').className = tab === 'obs' ? 'nav-btn active' : 'nav-btn';
      document.getElementById('btnTabAsis').className = tab === 'asis' ? 'nav-btn active' : 'nav-btn';
      if(tab === 'obs') setTimeout(resizeCanvas, 200);
  };

  // TOGGLE HISTORIAL (Mostrar/Ocultar)
  window.toggleHistorial = (id) => {
      const el = document.getElementById(id);
      if(el.style.display === 'none' || el.style.display === '') {
          el.style.display = 'block';
      } else {
          el.style.display = 'none';
      }
  };

  document.getElementById('fecha').valueAsDate = new Date();
  document.getElementById('fechaAsistencia').valueAsDate = new Date();
  const today = new Date();
  document.getElementById('mesReporte').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

  // --- ASISTENCIA ---
  window.renderAsistencia = () => {
      const container = document.getElementById('attendanceList');
      let html = '';
      estudiantesBase.forEach(est => {
          const estado = asistenciaTemp[est.doc] || 'P';
          html += `
          <div class="att-row">
              <div>
                  <div class="att-name">${est.nombre}</div>
                  <div class="att-doc">${est.doc}</div>
              </div>
              <div class="att-options">
                  <button class="att-btn ${estado === 'P' ? 'active-p' : ''}" onclick="setAtt('${est.doc}', 'P')">Asisti√≥</button>
                  <button class="att-btn ${estado === 'E' ? 'active-e' : ''}" onclick="setAtt('${est.doc}', 'E')">Excusa</button>
                  <button class="att-btn ${estado === 'I' ? 'active-i' : ''}" onclick="setAtt('${est.doc}', 'I')">Injustif.</button>
              </div>
          </div>`;
      });
      container.innerHTML = html;
  };

  window.setAtt = (doc, status) => {
      asistenciaTemp[doc] = status;
      renderAsistencia();
  };

  window.cargarAsistenciaDelDia = async () => {
      const fecha = document.getElementById('fechaAsistencia').value;
      if(!fecha) return;
      try {
          const docSnap = await getDoc(doc(db, "controlAsistencia", fecha));
          if (docSnap.exists()) {
              const data = docSnap.data();
              asistenciaTemp = {};
              if(data.detalles) data.detalles.forEach(d => asistenciaTemp[d.doc] = d.estado);
          } else {
              asistenciaTemp = {};
          }
          renderAsistencia();
      } catch (e) { console.error(e); }
  };

  window.guardarAsistencia = async () => {
      const fecha = document.getElementById('fechaAsistencia').value;
      if(!fecha) return alert("Seleccione fecha");
      const dataToSave = {
          fecha: fecha, timestamp: new Date().toISOString(),
          detalles: estudiantesBase.map(est => ({ doc: est.doc, nombre: est.nombre, estado: asistenciaTemp[est.doc] || 'P' }))
      };
      try {
          await setDoc(doc(db, "controlAsistencia", fecha), dataToSave);
          alert("‚úÖ Asistencia guardada.");
      } catch(e) { alert("Error: " + e.message); }
  };
  window.cargarAsistenciaDelDia();

  // --- REPORTE MENSUAL ---
  window.descargarReporteMensual = async () => {
      const mesInput = document.getElementById('mesReporte').value;
      if(!mesInput) return alert("Seleccione un mes.");
      const [year, month] = mesInput.split('-');
      const daysInMonth = new Date(year, month, 0).getDate();
      const startDate = `${mesInput}-01`;
      const endDate = `${mesInput}-${daysInMonth}`;

      const q = query(collection(db, "controlAsistencia"), where("fecha", ">=", startDate), where("fecha", "<=", endDate));
      const querySnapshot = await getDocs(q);
      const asistenciaMes = {}; 
      querySnapshot.forEach((doc) => {
          const data = doc.data();
          const dayData = {};
          if(data.detalles) data.detalles.forEach(d => dayData[d.doc] = d.estado);
          asistenciaMes[data.fecha] = dayData;
      });

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l', 'mm', 'a4');
      pdf.setFontSize(14); pdf.setTextColor(27, 94, 32);
      pdf.text(`Control de Asistencia Mensual - ${mesInput}`, 14, 15);
      
      const headRow = ['Estudiante'];
      for(let i=1; i<=daysInMonth; i++) headRow.push(String(i));
      headRow.push('Fallas'); headRow.push('Excusas');

      const bodyData = estudiantesBase.map(est => {
          const row = [est.nombre];
          let totalFallas = 0; let totalExcusas = 0;
          for(let i=1; i<=daysInMonth; i++) {
              const diaStr = String(i).padStart(2, '0');
              const fechaFull = `${mesInput}-${diaStr}`;
              let estado = ' ';
              if(asistenciaMes[fechaFull]) {
                  const estadoDia = asistenciaMes[fechaFull][est.doc];
                  if(estadoDia === 'I') { estado = 'X'; totalFallas++; }
                  else if(estadoDia === 'E') { estado = 'E'; totalExcusas++; }
                  else if(estadoDia === 'P') { estado = '‚Ä¢'; }
              }
              row.push(estado);
          }
          row.push(String(totalFallas)); row.push(String(totalExcusas));
          return row;
      });

      pdf.autoTable({
          startY: 20, head: [headRow], body: bodyData, theme: 'grid',
          styles: { fontSize: 6, cellPadding: 1, halign: 'center' },
          columnStyles: { 0: { halign: 'left', cellWidth: 40 } },
          headStyles: { fillColor: [27, 94, 32] },
          didParseCell: function(data) {
              if (data.section === 'body' && data.column.index > 0) {
                  if(data.cell.raw === 'X') data.cell.styles.textColor = [200, 0, 0];
                  if(data.cell.raw === 'E') data.cell.styles.textColor = [200, 100, 0];
              }
          }
      });
      pdf.save(`Asistencia_Mensual_${mesInput}.pdf`);
  };

  // --- CANVAS FIRMA ---
  const canvas = document.getElementById('signaturePad');
  const ctx = canvas.getContext('2d');
  let isDrawing = false;

  function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      ctx.scale(ratio, ratio);
  }
  window.addEventListener('resize', resizeCanvas);
  setTimeout(resizeCanvas, 500); 

  const getPos = (e) => {
      const rect = canvas.getBoundingClientRect();
      const t = e.touches ? e.touches[0] : e;
      return { x: t.clientX - rect.left, y: t.clientY - rect.top };
  }
  const startDraw = (e) => { e.preventDefault(); isDrawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); };
  const moveDraw = (e) => { e.preventDefault(); if(!isDrawing)return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); };
  const endDraw = () => { isDrawing=false; };

  canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', moveDraw); window.addEventListener('mouseup', endDraw);
  canvas.addEventListener('touchstart', startDraw, {passive:false}); canvas.addEventListener('touchmove', moveDraw, {passive:false}); canvas.addEventListener('touchend', endDraw);
  document.getElementById('btnLimpiar').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
  function isCanvasBlank(c) {
      const context = c.getContext('2d');
      const pixelBuffer = new Uint32Array(context.getImageData(0, 0, c.width, c.height).data.buffer);
      return !pixelBuffer.some(color => color !== 0);
  }

  // --- LISTENERS FIREBASE ---
  onSnapshot(collection(db, "registrosComportamentales"), (snap) => {
    allRegistros = [];
    snap.forEach(doc => allRegistros.push({id: doc.id, ...doc.data()}));
    renderRegistros();
  });
  onSnapshot(collection(db, "excusasInasistencia"), (snap) => {
    allExcusas = [];
    snap.forEach(doc => allExcusas.push({id: doc.id, ...doc.data()}));
    renderExcusas();
  });

  // --- RENDERIZADO REGISTROS ---
  window.renderRegistros = () => {
    const container = document.getElementById('listaRegistros');
    const search = document.getElementById('buscador').value.toLowerCase();
    const filtered = allRegistros.filter(r => (r.nombreEstudiante||'').toLowerCase().includes(search) || (r.documentoEstudiante||'').includes(search));

    if(filtered.length === 0) {
        container.innerHTML = '<div style="padding:15px; text-align:center; color:#888;">No se encontraron registros.</div>';
        return;
    }

    const grupos = {};
    filtered.forEach(r => {
        const key = r.documentoEstudiante || 'SIN_DOC';
        if(!grupos[key]) grupos[key] = { nombre: r.nombreEstudiante, docs: [] };
        grupos[key].docs.push(r);
    });

    let html = '';
    Object.keys(grupos).forEach(key => {
        const g = grupos[key];
        g.docs.sort((a,b) => (a.fecha||'') < (b.fecha||'') ? 1 : -1);

        html += `
        <div class="student-block">
            <div class="student-info-bar">
                <div><div class="st-name">${g.nombre || 'Sin Nombre'}</div><div class="st-doc">Doc: ${key} ¬∑ Registros: ${g.docs.length}</div></div>
                <button class="btn-blue" onclick="descargarPDF('${key}')">Descargar PDF</button>
            </div>
            <div class="table-container">
            <table>
                <thead><tr><th style="width:90px;">Fecha</th><th>Detalle</th><th>Firmas</th><th style="width:90px;">Acci√≥n</th></tr></thead>
                <tbody>
        `;
        g.docs.forEach(r => {
            const tipo = r.tipoRegistro || 'Comportamental';
            const claseTipo = tipo === 'Acad√©mico' ? 'tag-acad' : 'tag-comp';
            html += `
                <tr>
                    <td><div style="font-size:12px;">${r.fecha}</div><span class="tag-type ${claseTipo}">${tipo.substring(0,4)}.</span></td>
                    <td><div style="font-weight:600; margin-bottom:4px;">${r.comportamiento}</div><div style="font-size:11px; color:#666;"><em>${r.procedimiento}</em></div></td>
                    <td><div style="font-size:11px;">${r.firmaAcudiente ? `<span style="color:green;">‚úÖ Firmado Acudiente</span>` : `<span style="color:red; font-weight:bold;">‚è≥ Pendiente</span>`}</div></td>
                    <td><div style="display:flex; gap:5px;">
                        <button class="bg-gray btn-icon btn-edit" onclick="editar('${r.id}')">‚úèÔ∏è</button>
                        <button class="bg-gray btn-icon btn-del" onclick="eliminarDocumento('${r.id}', 'registrosComportamentales')">üóëÔ∏è</button>
                    </div></td>
                </tr>`;
        });
        html += `</tbody></table></div></div>`;
    });
    container.innerHTML = html;
  };

  // --- RENDERIZADO EXCUSAS ---
  window.renderExcusas = () => {
    const container = document.getElementById('listaExcusas');
    if(allExcusas.length === 0) {
        container.innerHTML = '<div style="padding:15px; text-align:center; color:#888;">No hay excusas.</div>';
        return;
    }
    allExcusas.sort((a,b) => (a.fechaEnvio||'') < (b.fechaEnvio||'') ? 1 : -1);
    let html = `
    <div class="table-container">
    <table>
        <thead><tr><th>Fecha Falta</th><th>Estudiante</th><th>Motivo</th><th>Detalle</th><th>Firma Acudiente</th><th style="width:50px;">Acci√≥n</th></tr></thead>
        <tbody>
    `;
    allExcusas.forEach(e => {
        const match = allRegistros.find(r => r.documentoEstudiante == e.documentoEstudiante);
        let nom = match ? match.nombreEstudiante : e.documentoEstudiante;
        if(!match) {
             const base = estudiantesBase.find(est => est.doc === e.documentoEstudiante);
             if(base) nom = base.nombre;
        }
        html += `
            <tr>
                <td>${e.fechaInasistencia}</td><td><b>${nom}</b></td><td>${e.motivoTipo}</td><td>${e.motivoDetalle}</td><td><img src="${e.firmaAcudiente}" class="sig-preview"></td>
                <td><button class="bg-gray btn-icon btn-del" onclick="eliminarDocumento('${e.id}', 'excusasInasistencia')">üóëÔ∏è</button></td>
            </tr>`;
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  };

  // --- CRUD REGISTRO ---
  const form = document.getElementById('formRegistro');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnGuardar');
    const id = document.getElementById('editId').value;
    const nombreInput = document.getElementById("inputEstudiante").value;
    
    // Obtener DOC usando el datalist
    let docSeleccionado = null;
    const opciones = document.getElementById("listaEstudiantes").options;
    for (let i = 0; i < opciones.length; i++) {
        if (opciones[i].value === nombreInput) {
            docSeleccionado = opciones[i].getAttribute("data-doc");
            break;
        }
    }

    if(!docSeleccionado) { alert("Seleccione un estudiante de la lista v√°lida."); return; }
    if(!id && isCanvasBlank(canvas)) { alert("Debe firmar el registro."); return; }

    btn.disabled = true;
    btn.innerText = "Guardando...";

    const data = {
        tipoRegistro: document.getElementById('tipoRegistro').value,
        fecha: document.getElementById('fecha').value,
        documentoEstudiante: docSeleccionado,
        nombreEstudiante: nombreInput,
        comportamiento: document.getElementById('comportamiento').value,
        descargos: document.getElementById('descargos').value,
        procedimiento: document.getElementById('procedimiento').value
    };

    if(!isCanvasBlank(canvas)) data.firma = canvas.toDataURL();

    try {
        if(id) {
            await updateDoc(doc(db, "registrosComportamentales", id), data);
            alert("Registro actualizado.");
            cancelarEdicion();
        } else {
            await addDoc(collection(db, "registrosComportamentales"), {
                ...data, timestamp: new Date().toISOString()
            });
            alert("Guardado con √©xito.");
            form.reset();
            ctx.clearRect(0,0,canvas.width,canvas.height);
        }
    } catch(err) { alert("Error: " + err.message); }
    btn.disabled = false;
    btn.innerText = "Guardar registro";
  });

  window.eliminarDocumento = async (id, coleccion) => {
      if(confirm("‚ö†Ô∏è ¬øEst√° seguro de eliminar este registro?\n\nEsta acci√≥n no se puede deshacer.")) {
          try { await deleteDoc(doc(db, coleccion, id)); } catch(e) { alert("Error al eliminar: " + e.message); }
      }
  };

  window.editar = (id) => {
    const r = allRegistros.find(x => x.id === id);
    if(!r) return;
    document.getElementById('editId').value = r.id;
    document.getElementById('tipoRegistro').value = r.tipoRegistro || 'Comportamental';
    document.getElementById('fecha').value = r.fecha;
    document.getElementById('inputEstudiante').value = r.nombreEstudiante;
    document.getElementById('comportamiento').value = r.comportamiento;
    document.getElementById('descargos').value = r.descargos;
    document.getElementById('procedimiento').value = r.procedimiento;
    
    document.getElementById('btnGuardar').innerText = "Actualizar";
    document.getElementById('divCancel').style.display = 'block';
    window.scrollTo({top:0, behavior:'smooth'});
  };

  window.cancelarEdicion = () => {
    form.reset();
    document.getElementById('editId').value = '';
    document.getElementById('btnGuardar').innerText = "Guardar registro";
    document.getElementById('divCancel').style.display = 'none';
    ctx.clearRect(0,0,canvas.width,canvas.height);
  };

  // --- PDF REPORTES ---
  window.descargarPDF = (docId) => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    const recs = allRegistros.filter(r => r.documentoEstudiante === docId);
    if(!recs.length) return;
    
    pdf.setFillColor(27, 94, 32); 
    pdf.rect(0, 0, 210, 30, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(16);
    pdf.text("Instituci√≥n Educativa de Mar√≠a", 14, 12);
    pdf.setFontSize(10);
    pdf.text("Reporte Disciplinario del Estudiante", 14, 20);
    pdf.setTextColor(0,0,0);
    pdf.text(`Nombre: ${recs[0].nombreEstudiante}`, 14, 40);
    pdf.text(`Documento: ${docId}`, 14, 46);
    
    const body = recs.map(r => [
        r.fecha,
        r.tipoRegistro || "Comportamental",
        r.comportamiento,
        r.procedimiento,
        r.firmaAcudiente ? "FIRMADO" : "PENDIENTE"
    ]);

    pdf.autoTable({
        startY: 55, head: [['Fecha', 'Tipo', 'Observaci√≥n', 'Procedimiento', 'Estado']], body: body,
        headStyles: { fillColor: [27, 94, 32] }
    });
    pdf.save(`Reporte_${recs[0].nombreEstudiante}.pdf`);
  };

  window.descargarExcusasPDF = () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.setFillColor(2, 136, 209);
    pdf.rect(0, 0, 210, 30, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(16);
    pdf.text("Instituci√≥n Educativa de Mar√≠a", 14, 12);
    pdf.setFontSize(10);
    pdf.text("Control de Ausentismo - Reporte General", 14, 20);
    pdf.setTextColor(0,0,0);
    pdf.text(`Fecha de generaci√≥n: ${new Date().toLocaleDateString()}`, 14, 40);
    
    const body = allExcusas.map(e => {
         const match = allRegistros.find(r => r.documentoEstudiante == e.documentoEstudiante);
         let nom = match ? match.nombreEstudiante : e.documentoEstudiante;
         if(!match) {
             const base = estudiantesBase.find(est => est.doc === e.documentoEstudiante);
             if(base) nom = base.nombre;
         }
         return [e.fechaInasistencia, nom, e.motivoTipo, e.motivoDetalle];
    });

    pdf.autoTable({
        startY: 50, head: [['Fecha Falta', 'Estudiante', 'Motivo', 'Detalle']], body: body,
        headStyles: { fillColor: [2, 136, 209] }
    });
    pdf.save(`Reporte_Excusas.pdf`);
  };
</script>
</body>
</html>


