<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de anotaciones - Acudiente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 { color: #2c5f2d; margin-bottom: 10px; }
    p { margin-bottom: 10px; }
    label { display:block; margin-bottom:5px; font-weight:bold; }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      font-size: 14px;
    }
    button {
      padding: 8px 14px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 5px;
      margin-right: 5px;
    }
    .btn-primary { background-color: #4CAF50; color: #fff; }
    .btn-secondary { background-color: #008CBA; color: #fff; }
    .btn-primary:hover { background-color: #45a049; }
    .btn-secondary:hover { background-color: #007399; }
    ul { list-style:none; padding-left:0; margin-top:10px; }
    li {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 8px;
      background-color: #fafafa;
      font-size: 14px;
    }
    li b { display:inline-block; min-width:140px; }
    canvas {
      border:1px solid #ccc;
      border-radius:4px;
      width:100%;
      height:200px;
      background-color:#fff;
      cursor:crosshair;
      margin-top:10px;
      display:block;
    }
    .estado-envio {
      font-size:12px;
      color:#555;
      margin-top:5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>I.E DE MARÍA, SEDE RURAL SANTA JUANA</h1>
    <h2>Consulta de anotaciones por ACUDIENTE</h2>
    <p>Ingrese el documento del estudiante para ver las anotaciones registradas.</p>

    <form id="loginForm">
      <label for="docEstudiante">Documento del estudiante:</label>
      <input type="text" id="docEstudiante" required />
      <button type="submit" class="btn-primary">Buscar</button>
    </form>

    <div id="resultados"></div>

    <div id="firmaSection" style="display:none; margin-top:20px;">
      <h3>Firma del acudiente</h3>
      <p>Firme dentro del recuadro y luego haga clic en "Enviar firma".</p>
      <canvas id="signaturePadAcudiente"></canvas>
      <button type="button" class="btn-secondary" id="btnLimpiarFirma">Limpiar firma</button>
      <button type="button" class="btn-primary" id="btnEnviarFirma">Enviar firma</button>
      <div id="estadoEnvio" class="estado-envio"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, query, where,
      getDocs, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
      authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
      projectId: "diariodeprocesos-6f78d",
      storageBucket: "diariodeprocesos-6f78d.firebasestorage.app",
      messagingSenderId: "487922338632",
      appId: "1:487922338632:web:47fc48c23dbea064b0817d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const registrosCol = collection(db, "registrosComportamentales");

    const loginForm = document.getElementById('loginForm');
    const resultadosDiv = document.getElementById('resultados');
    const firmaSection = document.getElementById('firmaSection');
    const canvas = document.getElementById('signaturePadAcudiente');
    const ctx = canvas.getContext('2d');
    const btnLimpiarFirma = document.getElementById('btnLimpiarFirma');
    const btnEnviarFirma = document.getElementById('btnEnviarFirma');
    const estadoEnvio = document.getElementById('estadoEnvio');

    let registros = [];          // lista de registros encontrados
    let registroSeleccionado = null; // el que el acudiente decide firmar

    function ajustarCanvas() {
      const w = canvas.getBoundingClientRect().width || 400;
      canvas.width = w;
      canvas.height = 200;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    ajustarCanvas();
    window.addEventListener('resize', ajustarCanvas);

    let isDrawing = false, lastX=0, lastY=0;
    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      let x,y;
      if (e.touches && e.touches[0]) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.offsetX ?? (e.clientX - rect.left);
        y = e.offsetY ?? (e.clientY - rect.top);
      }
      return {x,y};
    }
    function startDrawing(e) {
      e.preventDefault();
      isDrawing = true;
      const p = getPos(e);
      lastX = p.x;
      lastY = p.y;
    }
    function draw(e) {
      if (!isDrawing) return;
      e.preventDefault();
      const p = getPos(e);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      lastX = p.x;
      lastY = p.y;
    }
    function stopDrawing(e) {
      e && e.preventDefault();
      isDrawing = false;
    }

    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mouseout", stopDrawing);
    canvas.addEventListener("touchstart", startDrawing, { passive:false });
    canvas.addEventListener("touchmove", draw, { passive:false });
    canvas.addEventListener("touchend", stopDrawing, { passive:false });

    btnLimpiarFirma.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      estadoEnvio.textContent = "";
    });

    function escapeHTML(s) {
      if (!s) return "";
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultadosDiv.innerHTML = "Buscando anotaciones...";
      firmaSection.style.display = "none";
      registroSeleccionado = null;
      estadoEnvio.textContent = "";

      const docEstudiante = document.getElementById('docEstudiante').value.trim();
      if (!docEstudiante) {
        resultadosDiv.innerHTML = "Ingrese un documento.";
        return;
      }

      try {
        const q = query(registrosCol, where("documentoEstudiante", "==", docEstudiante));
        const snap = await getDocs(q);

        if (snap.empty) {
          resultadosDiv.innerHTML = "No se encontraron anotaciones para este documento.";
          return;
        }

        registros = [];
        snap.forEach(d => {
          registros.push({ firebaseId: d.id, ...d.data() });
        });

        let html = "<h3>Anotaciones encontradas</h3><ul>";
        registros.sort((a,b) => (a.fecha || "").localeCompare(b.fecha || ""));
        registros.forEach((r, idx) => {
          html += `<li>
            <b>Fecha:</b> ${escapeHTML(r.fecha || "")}<br/>
            <b>Estudiante:</b> ${escapeHTML(r.nombreEstudiante || "")}<br/>
            <b>Documento:</b> ${escapeHTML(r.documentoEstudiante || "")}<br/>
            <b>Comportamiento:</b> ${escapeHTML(r.comportamiento || "")}<br/>
            <b>Descargos:</b> ${escapeHTML(r.descargos || "")}<br/>
            <b>Procedimiento:</b> ${escapeHTML(r.procedimiento || "")}<br/>
            <b>Firma acudiente:</b> ${r.firmaAcudiente ? "Ya firmó" : "Pendiente"}<br/>
            <button type="button" class="btn-secondary" data-idx="${idx}">
              Firmar esta anotación
            </button>
          </li>`;
        });
        html += "</ul>";
        resultadosDiv.innerHTML = html;

        document.querySelectorAll('button[data-idx]').forEach(btn => {
          btn.addEventListener('click', () => {
            const i = parseInt(btn.getAttribute('data-idx'));
            registroSeleccionado = registros[i];
            firmaSection.style.display = "block";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            estadoEnvio.textContent = "";
            window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
          });
        });

      } catch (err) {
        console.error(err);
        resultadosDiv.innerHTML = "Error al buscar. Revise la consola.";
      }
    });

    btnEnviarFirma.addEventListener('click', async () => {
      if (!registroSeleccionado) {
        alert("Primero seleccione una anotación para firmar.");
        return;
      }
      if (!navigator.onLine) {
        alert("Se necesita internet para enviar la firma.");
        return;
      }

      try {
        btnEnviarFirma.disabled = true;
        estadoEnvio.textContent = "Enviando firma...";

        const firmaData = canvas.toDataURL("image/png");
        const hoy = new Date().toISOString().slice(0,10);

        const ref = doc(db, "registrosComportamentales", registroSeleccionado.firebaseId);
        await updateDoc(ref, {
          firmaAcudiente: firmaData,
          fechaFirmaAcudiente: hoy
        });

        estadoEnvio.textContent = "Firma enviada correctamente.";
        alert("Firma enviada. El docente ya puede verla en su aplicativo.");
        firmaSection.style.display = "none";
        // volver a buscar para que actualice el estado
        loginForm.dispatchEvent(new Event("submit"));
      } catch (err) {
        console.error(err);
        alert("Error al enviar la firma. Revise la consola.");
        estadoEnvio.textContent = "Error al enviar la firma.";
      } finally {
        btnEnviarFirma.disabled = false;
      }
    });
  </script>
</body>
</html>
