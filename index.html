<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Seguimiento disciplinario - Docente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #22c55e;
      --primary-dark: #16a34a;
      --accent: #0ea5e9;
      --bg: #bbf7d0;
      --card-bg: #ffffff;
      --border: #cbd5e1;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 30px rgba(15,23,42,0.12);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #bbf7d0, #f9fafb 55%);
      min-height: 100vh;
      padding: 16px;
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #22c55e55;
      background: white;
      flex-shrink: 0;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 700;
      color: #064e3b;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .brand-meta {
      font-size: 11px;
      color: #0f172a;
      font-weight: 500;
    }

    .connection-status {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .connection-status.online {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #4ade80;
    }

    .connection-status.offline {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    @media (max-width: 900px) {
      body { padding: 10px; }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #064e3b;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px 14px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      color: #0f172a;
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
      font-size: 13px;
      color: var(--text-main);
      outline: none;
      transition: border 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: #94a3b8;
    }

    input:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
      background: #ffffff;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      border: none;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      padding: 8px 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }

    button:active { transform: scale(0.97); }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #ecfdf5;
      box-shadow: 0 10px 20px rgba(34,197,94,0.35);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #0ea5e9, #0369a1);
      color: #e0f2fe;
      box-shadow: 0 10px 20px rgba(56,189,248,0.35);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color: #fee2e2;
      box-shadow: 0 10px 20px rgba(248,113,113,0.35);
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 999px;
    }

    .btn-muted {
      background: #e2e8f0;
      color: #0f172a;
      box-shadow: none;
    }

    .records-list {
      margin-top: 10px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #ffffff;
    }

    .records-list::-webkit-scrollbar { width: 6px; }
    .records-list::-webkit-scrollbar-track { background: #ffffff; }
    .records-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 999px;
    }

    .student-section {
      border-radius: var(--radius-md);
      border: 1px solid #e2e8f0;
      background: #f9fafb;
      padding: 10px;
      margin-bottom: 10px;
    }

    .student-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .student-title {
      font-size: 13px;
      font-weight: 600;
      color: #022c22;
    }

    .student-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border: 1px solid #e2e8f0;
      padding: 6px 6px;
      vertical-align: top;
    }

    th {
      background: #16a34a;
      color: #ecfdf5;
      font-weight: 600;
      text-align: left;
    }

    tr:nth-child(even) td {
      background: #f1f5f9;
    }

    .signature-preview {
      max-width: 110px;
      max-height: 40px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: white;
    }

    .info-text {
      font-size: 11px;
      color: var(--text-muted);
    }

    canvas.signature-pad {
      border-radius: 14px;
      border: 1px dashed #cbd5e1;
      background: #ffffff;
      width: 100%;
      height: 220px;
      display: block;
      cursor: crosshair;
      margin-top: 6px;
      touch-action: none;
    }

    @media (max-width: 600px) {
      body { padding: 10px; }
      .card { padding: 16px 14px 14px; }
      canvas.signature-pad { height: 200px; }
      th, td { font-size: 11px; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- ENCABEZADO -->
    <header class="top-bar">
      <div class="brand">
        <div class="brand-logo">
          <!-- escudo.png debe estar en la misma carpeta -->
          <img src="escudo.png" alt="Escudo Institución Educativa de María">
        </div>
        <div class="brand-text">
          <div class="brand-title">Institución Educativa de María</div>
          <div class="brand-subtitle">Sede Rural Santa Juana (Primaria) · 2026</div>
          <div class="brand-meta">Seguimiento comportamental y disciplinario</div>
        </div>
      </div>
      <div id="connStatus" class="connection-status offline">
        <span class="connection-dot"></span><span>Offline</span>
      </div>
    </header>

    <!-- REGISTRO DEL DOCENTE -->
    <section class="card">
      <div class="card-title">Registro del docente</div>
      <div class="card-subtitle">
        Diligencie los campos y registre la firma del estudiante / docente. Los registros se
        guardan en Firebase y se agrupan por estudiante.
      </div>

      <form id="formRegistro">
        <input type="hidden" id="editId" />

        <div class="form-grid">
          <div class="form-group">
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" required />
          </div>

          <div class="form-group">
            <label for="documentoEstudiante">Documento del estudiante</label>
            <input type="text" id="documentoEstudiante" required placeholder="Ej: 123456789" />
          </div>

          <div class="form-group">
            <label for="nombreEstudiante">Nombre del estudiante</label>
            <input type="text" id="nombreEstudiante" required placeholder="Nombre completo" />
          </div>
        </div>

        <div class="form-group">
          <label for="comportamiento">Descripción del comportamiento</label>
          <textarea id="comportamiento" required placeholder="Explique brevemente la situación presentada..."></textarea>
        </div>

        <div class="form-group">
          <label for="descargos">Descargos (versión del estudiante)</label>
          <textarea id="descargos" required placeholder="Registre lo manifestado por el estudiante..."></textarea>
        </div>

        <div class="form-group">
          <label for="procedimiento">Procedimiento / acciones a seguir</label>
          <textarea id="procedimiento" required placeholder="Compromisos, acuerdos, remisiones, etc."></textarea>
        </div>

        <div class="form-group">
          <label>Firma estudiante / docente</label>
          <div class="field-hint">Dibuje aquí la firma correspondiente antes de guardar el registro.</div>
          <canvas id="signaturePad" class="signature-pad"></canvas>
          <div class="button-row">
            <button type="button" class="btn-danger" id="btnLimpiarFirma">Limpiar firma</button>
          </div>
        </div>

        <div class="button-row">
          <button type="submit" class="btn-primary" id="btnGuardar">Guardar registro</button>
          <button type="button" class="btn-muted" id="btnCancelarEdicion" style="display:none;">Cancelar edición</button>
        </div>
      </form>
    </section>

    <!-- REGISTROS POR ESTUDIANTE -->
    <section class="card">
      <div class="card-title">Registros comportamentales por estudiante</div>
      <div class="card-subtitle">
        Visualice todos los registros realizados y descargue el historial de cada estudiante en PDF.
      </div>

      <div class="form-group">
        <label for="buscarRegistros">Buscar por nombre o documento</label>
        <input type="text" id="buscarRegistros" placeholder="Escriba parte del nombre o documento..." />
      </div>

      <div id="registrosContainer" class="records-list"></div>
    </section>

    <!-- CONTROL Y SEGUIMIENTO DE AUSENTISMO -->
    <section class="card">
      <div class="card-title">Control y seguimiento de ausentismo escolar</div>
      <div class="card-subtitle">
        Excusas enviadas por los acudientes a través del portal del acudiente. Se agrupan por estudiante.
      </div>

      <div class="form-group">
        <label for="buscarExcusas">Buscar por nombre o documento</label>
        <input type="text" id="buscarExcusas" placeholder="Escriba parte del nombre o documento..." />
      </div>

      <div id="excusasContainer" class="records-list"></div>
      <div class="info-text">
        Nota: las excusas se leen desde la colección <strong>excusasInasistencia</strong> de Firebase.
      </div>
    </section>
  </div>

  <!-- LÓGICA FIREBASE Y APLICATIVO -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
      getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ---------- CONFIG FIREBASE ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
      authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
      projectId: "diariodeprocesos-6f78d",
      storageBucket: "diariodeprocesos-6f78d.firebasestorage.app",
      messagingSenderId: "487922338632",
      appId: "1:487922338632:web:47fc48c23dbea064b0817d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRegistros = collection(db, "registrosComportamentales");
    const colExcusas   = collection(db, "excusasInasistencia");

    // ---------- ESTADO CONEXIÓN ----------
    const connStatus = document.getElementById('connStatus');
    function actualizarConexion() {
      if (navigator.onLine) {
        connStatus.className = "connection-status online";
        connStatus.innerHTML = '<span class="connection-dot"></span><span>Online - Conectado</span>';
      } else {
        connStatus.className = "connection-status offline";
        connStatus.innerHTML = '<span class="connection-dot"></span><span>Offline (solo lectura)</span>';
      }
    }
    window.addEventListener('online', actualizarConexion);
    window.addEventListener('offline', actualizarConexion);
    actualizarConexion();

    // ---------- ESTADO LOCAL ----------
    let registros = [];
    let excusas = [];
    let studentNamesByDoc = {}; // documento -> nombre
    const escudoImg = new Image();
    escudoImg.src = "escudo.png";

    // ---------- UTILIDADES ----------
    function escapeHTML(s) {
      if (!s) return "";
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function agruparPor(arr, claveFn) {
      const res = {};
      arr.forEach(item => {
        const key = claveFn(item);
        if (!res[key]) res[key] = [];
        res[key].push(item);
      });
      return res;
    }

    // ---------- CARGA DE REGISTROS ----------
    async function cargarRegistros() {
      try {
        const snap = await getDocs(colRegistros);
        registros = [];
        studentNamesByDoc = {};
        snap.forEach(d => {
          const data = d.data();
          const r = {
            firebaseId: d.id,
            id: data.id || Date.now(),
            fecha: data.fecha || "",
            documentoEstudiante: data.documentoEstudiante || "",
            nombreEstudiante: data.nombreEstudiante || "",
            comportamiento: data.comportamiento || "",
            descargos: data.descargos || "",
            procedimiento: data.procedimiento || "",
            firma: data.firma || data.firmaEstudianteDocente || "",
            firmaAcudiente: data.firmaAcudiente || "",
            fechaFirmaAcudiente: data.fechaFirmaAcudiente || ""
          };
          registros.push(r);
          if (r.documentoEstudiante && r.nombreEstudiante && !studentNamesByDoc[r.documentoEstudiante]) {
            studentNamesByDoc[r.documentoEstudiante] = r.nombreEstudiante;
          }
        });
        localStorage.setItem("registrosComportamentales", JSON.stringify(registros));
        renderRegistros();
        renderExcusas(); // para tener nombres actualizados
      } catch (err) {
        console.error("Error cargando registros:", err);
        registros = JSON.parse(localStorage.getItem("registrosComportamentales") || "[]");
        registros.forEach(r => {
          if (r.documentoEstudiante && r.nombreEstudiante && !studentNamesByDoc[r.documentoEstudiante]) {
            studentNamesByDoc[r.documentoEstudiante] = r.nombreEstudiante;
          }
        });
        renderRegistros();
      }
    }

    // ---------- CARGA DE EXCUSAS ----------
    async function cargarExcusas() {
      try {
        const snap = await getDocs(colExcusas);
        excusas = [];
        snap.forEach(d => {
          const data = d.data();
          excusas.push({
            firebaseId: d.id,
            documentoEstudiante: data.documentoEstudiante || "",
            fechaInasistencia: data.fechaInasistencia || "",
            motivoTipo: data.motivoTipo || "",
            motivoDetalle: data.motivoDetalle || "",
            firmaAcudiente: data.firmaAcudiente || "",
            fechaEnvio: data.fechaEnvio || ""
          });
        });
        localStorage.setItem("excusasInasistencia", JSON.stringify(excusas));
        renderExcusas();
      } catch (err) {
        console.error("Error cargando excusas:", err);
        excusas = JSON.parse(localStorage.getItem("excusasInasistencia") || "[]");
        renderExcusas();
      }
    }

    // ---------- RENDER REGISTROS ----------
    const registrosContainer = document.getElementById('registrosContainer');
    const buscarRegistrosInput = document.getElementById('buscarRegistros');

    function renderRegistros() {
      let datos = registros.slice();
      const term = (buscarRegistrosInput.value || "").toLowerCase().trim();
      if (term) {
        datos = datos.filter(r =>
          (r.nombreEstudiante || "").toLowerCase().includes(term) ||
          (r.documentoEstudiante || "").toLowerCase().includes(term)
        );
      }

      if (!datos.length) {
        registrosContainer.innerHTML = '<div class="info-text">No hay registros para mostrar.</div>';
        return;
      }

      const agrupados = agruparPor(datos, r => r.documentoEstudiante || "Sin documento");
      const docs = Object.keys(agrupados).sort();

      let html = "";
      docs.forEach(docEst => {
        const lista = agrupados[docEst];
        const nombre = lista[0].nombreEstudiante || studentNamesByDoc[docEst] || "Sin nombre";
        html += '<div class="student-section">';
        html += '  <div class="student-header">';
        html += '    <div>';
        html += '      <div class="student-title">Estudiante: ' + escapeHTML(nombre) + '</div>';
        html += '      <div class="student-meta">Documento: ' + escapeHTML(docEst) + ' · Registros: ' + lista.length + '</div>';
        html += '    </div>';
        html += '    <div class="button-row">';
        html += '      <button type="button" class="btn-secondary btn-small" onclick="downloadRegistroPDF(\'' +
          docEst.replace(/'/g, "\\'") + '\')">Descargar PDF de seguimiento</button>';
        html += '    </div>';
        html += '  </div>';

        html += '  <div class="table-wrapper">';
        html += '    <table>';
        html += '      <thead><tr>';
        html += '        <th>Fecha</th>';
        html += '        <th>Comportamiento</th>';
        html += '        <th>Descargos</th>';
        html += '        <th>Procedimiento</th>';
        html += '        <th>Firma estudiante/docente</th>';
        html += '        <th>Firma acudiente</th>';
        html += '        <th>Acciones</th>';
        html += '      </tr></thead>';
        html += '      <tbody>';

        lista.sort((a,b) => (a.fecha || "").localeCompare(b.fecha || ""));
        lista.forEach(r => {
          html += '      <tr>';
          html += '        <td>' + escapeHTML(r.fecha || "") + '</td>';
          html += '        <td>' + escapeHTML(r.comportamiento || "") + '</td>';
          html += '        <td>' + escapeHTML(r.descargos || "") + '</td>';
          html += '        <td>' + escapeHTML(r.procedimiento || "") + '</td>';
          html += '        <td>';
          if (r.firma) {
            html += '<img class="signature-preview" src="' + r.firma + '" alt="Firma estudiante/docente">';
          } else {
            html += '<span class="info-text">Sin firma</span>';
          }
          html += '        </td>';
          html += '        <td>';
          if (r.firmaAcudiente) {
            html += '<img class="signature-preview" src="' + r.firmaAcudiente + '" alt="Firma acudiente">';
          } else {
            html += '<span class="info-text">Pendiente</span>';
          }
          html += '        </td>';
          html += '        <td>';
          html += '          <button type="button" class="btn-muted btn-small" onclick="editRecord(\'' + r.firebaseId + '\')">Editar</button> ';
          html += '          <button type="button" class="btn-danger btn-small" onclick="deleteRecord(\'' + r.firebaseId + '\')">Eliminar</button>';
          html += '        </td>';
          html += '      </tr>';
        });

        html += '      </tbody>';
        html += '    </table>';
        html += '  </div>';
        html += '</div>';
      });

      registrosContainer.innerHTML = html;
    }

    buscarRegistrosInput.addEventListener('input', renderRegistros);

    // ---------- RENDER EXCUSAS ----------
    const excusasContainer = document.getElementById('excusasContainer');
    const buscarExcusasInput = document.getElementById('buscarExcusas');

    function renderExcusas() {
      let datos = excusas.slice();
      const term = (buscarExcusasInput.value || "").toLowerCase().trim();
      if (term) {
        datos = datos.filter(e =>
          (e.documentoEstudiante || "").toLowerCase().includes(term) ||
          (studentNamesByDoc[e.documentoEstudiante] || "").toLowerCase().includes(term)
        );
      }

      if (!datos.length) {
        excusasContainer.innerHTML = '<div class="info-text">No hay excusas para mostrar.</div>';
        return;
      }

      const agrupados = agruparPor(datos, e => e.documentoEstudiante || "Sin documento");
      const docs = Object.keys(agrupados).sort();

      let html = "";
      docs.forEach(docEst => {
        const lista = agrupados[docEst];
        const nombre = studentNamesByDoc[docEst] || "Sin nombre registrado";
        html += '<div class="student-section">';
        html += '  <div class="student-header">';
        html += '    <div>';
        html += '      <div class="student-title">Estudiante: ' + escapeHTML(nombre) + '</div>';
        html += '      <div class="student-meta">Documento: ' + escapeHTML(docEst) + ' · Excusas: ' + lista.length + '</div>';
        html += '    </div>';
        html += '    <div class="button-row">';
        html += '      <button type="button" class="btn-secondary btn-small" onclick="downloadExcusasPDF(\'' +
          docEst.replace(/'/g, "\\'") + '\')">Descargar PDF de excusas</button>';
        html += '    </div>';
        html += '  </div>';

        html += '  <div class="table-wrapper">';
        html += '    <table>';
        html += '      <thead><tr>';
        html += '        <th>Fecha de inasistencia</th>';
        html += '        <th>Motivo</th>';
        html += '        <th>Descripción</th>';
        html += '        <th>Firma acudiente</th>';
        html += '      </tr></thead>';
        html += '      <tbody>';

        lista.sort((a,b) => (a.fechaInasistencia || "").localeCompare(b.fechaInasistencia || ""));
        lista.forEach(e => {
          html += '      <tr>';
          html += '        <td>' + escapeHTML(e.fechaInasistencia || "") + '</td>';
          html += '        <td>' + escapeHTML(e.motivoTipo || "") + '</td>';
          html += '        <td>' + escapeHTML(e.motivoDetalle || "") + '</td>';
          html += '        <td>';
          if (e.firmaAcudiente) {
            html += '<img class="signature-preview" src="' + e.firmaAcudiente + '" alt="Firma acudiente">';
          } else {
            html += '<span class="info-text">Sin firma</span>';
          }
          html += '        </td>';
          html += '      </tr>';
        });

        html += '      </tbody>';
        html += '    </table>';
        html += '  </div>';
        html += '</div>';
      });

      excusasContainer.innerHTML = html;
    }

    buscarExcusasInput.addEventListener('input', renderExcusas);

    // ---------- FIRMA REGISTRO DOCENTE ----------
    const signaturePad = document.getElementById('signaturePad');
    const sigCtx = signaturePad.getContext('2d');
    const btnLimpiarFirma = document.getElementById('btnLimpiarFirma');

    function ajustarCanvasFirma() {
      const w = signaturePad.getBoundingClientRect().width || 600;
      signaturePad.width = w;
      signaturePad.height = 220;
      sigCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
    }
    ajustarCanvasFirma();
    window.addEventListener('resize', ajustarCanvasFirma);

    let dibujando = false, sx = 0, sy = 0;
    function getPosFirma(e) {
      const rect = signaturePad.getBoundingClientRect();
      let x, y;
      if (e.touches && e.touches[0]) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.offsetX ?? (e.clientX - rect.left);
        y = e.offsetY ?? (e.clientY - rect.top);
      }
      return { x, y };
    }
    function startDraw(e) {
      e.preventDefault();
      dibujando = true;
      const p = getPosFirma(e);
      sx = p.x; sy = p.y;
    }
    function draw(e) {
      if (!dibujando) return;
      e.preventDefault();
      const p = getPosFirma(e);
      sigCtx.strokeStyle = "#0f172a";
      sigCtx.lineWidth = 2.2;
      sigCtx.lineCap = "round";
      sigCtx.beginPath();
      sigCtx.moveTo(sx, sy);
      sigCtx.lineTo(p.x, p.y);
      sigCtx.stroke();
      sx = p.x; sy = p.y;
    }
    function stopDraw(e) {
      e && e.preventDefault();
      dibujando = false;
    }

    signaturePad.addEventListener("mousedown", startDraw);
    signaturePad.addEventListener("mousemove", draw);
    signaturePad.addEventListener("mouseup", stopDraw);
    signaturePad.addEventListener("mouseout", stopDraw);
    signaturePad.addEventListener("touchstart", startDraw, { passive:false });
    signaturePad.addEventListener("touchmove", draw, { passive:false });
    signaturePad.addEventListener("touchend", stopDraw, { passive:false });

    btnLimpiarFirma.addEventListener('click', () => {
      sigCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
    });

    // ---------- CRUD REGISTROS ----------
    const formRegistro = document.getElementById('formRegistro');
    const editIdInput = document.getElementById('editId');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnCancelarEdicion = document.getElementById('btnCancelarEdicion');
    const fechaInput = document.getElementById('fecha');
    const docInput = document.getElementById('documentoEstudiante');
    const nombreInput = document.getElementById('nombreEstudiante');
    const compInput = document.getElementById('comportamiento');
    const descInput = document.getElementById('descargos');
    const procInput = document.getElementById('procedimiento');

    fechaInput.valueAsDate = new Date();

    formRegistro.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!navigator.onLine) {
        alert("Se necesita conexión a internet para guardar el registro.");
        return;
      }

      const registro = {
        fecha: fechaInput.value,
        documentoEstudiante: docInput.value.trim(),
        nombreEstudiante: nombreInput.value.trim(),
        comportamiento: compInput.value.trim(),
        descargos: descInput.value.trim(),
        procedimiento: procInput.value.trim(),
        firma: signaturePad.toDataURL("image/png")
      };

      if (!registro.fecha || !registro.documentoEstudiante || !registro.nombreEstudiante) {
        alert("Complete todos los campos obligatorios.");
        return;
      }

      try {
        if (editIdInput.value) {
          // actualizar
          const firebaseId = editIdInput.value;
          await updateDoc(doc(db, "registrosComportamentales", firebaseId), registro);
          const idx = registros.findIndex(r => r.firebaseId === firebaseId);
          if (idx !== -1) {
            registros[idx] = { ...registros[idx], ...registro };
          }
          alert("Registro actualizado correctamente.");
        } else {
          // nuevo
          registro.id = Date.now();
          const ref = await addDoc(colRegistros, registro);
          registros.push({ ...registro, firebaseId: ref.id });
          alert("Registro guardado correctamente.");
        }

        if (registro.documentoEstudiante && registro.nombreEstudiante) {
          studentNamesByDoc[registro.documentoEstudiante] = registro.nombreEstudiante;
        }

        localStorage.setItem("registrosComportamentales", JSON.stringify(registros));
        formRegistro.reset();
        fechaInput.valueAsDate = new Date();
        sigCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
        editIdInput.value = "";
        btnGuardar.textContent = "Guardar registro";
        btnCancelarEdicion.style.display = "none";
        renderRegistros();
        renderExcusas(); // por si es un nuevo estudiante
      } catch (err) {
        console.error("Error al guardar:", err);
        alert("Error al guardar el registro.");
      }
    });

    function cargarRegistroEnFormulario(firebaseId) {
      const r = registros.find(x => x.firebaseId === firebaseId);
      if (!r) return;
      fechaInput.value = r.fecha || "";
      docInput.value = r.documentoEstudiante || "";
      nombreInput.value = r.nombreEstudiante || "";
      compInput.value = r.comportamiento || "";
      descInput.value = r.descargos || "";
      procInput.value = r.procedimiento || "";
      editIdInput.value = firebaseId;
      btnGuardar.textContent = "Actualizar registro";
      btnCancelarEdicion.style.display = "inline-flex";

      // mostrar firma almacenada (si existe)
      sigCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
      if (r.firma) {
        const img = new Image();
        img.onload = () => {
          sigCtx.drawImage(img, 0, 0, signaturePad.width, signaturePad.height);
        };
        img.src = r.firma;
      }

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    btnCancelarEdicion.addEventListener('click', () => {
      formRegistro.reset();
      fechaInput.valueAsDate = new Date();
      editIdInput.value = "";
      btnGuardar.textContent = "Guardar registro";
      btnCancelarEdicion.style.display = "none";
      sigCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
    });

    async function eliminarRegistro(firebaseId) {
      if (!confirm("¿Está seguro de eliminar este registro?")) return;
      if (!navigator.onLine) {
        alert("Se necesita conexión a internet para eliminar.");
        return;
      }
      try {
        await deleteDoc(doc(db, "registrosComportamentales", firebaseId));
        registros = registros.filter(r => r.firebaseId !== firebaseId);
        localStorage.setItem("registrosComportamentales", JSON.stringify(registros));
        renderRegistros();
      } catch (err) {
        console.error("Error al eliminar:", err);
        alert("Error al eliminar el registro.");
      }
    }

    // Exponer funciones a window para los botones inline
    window.editRecord = cargarRegistroEnFormulario;
    window.deleteRecord = eliminarRegistro;

    // ---------- PDF REGISTROS ----------
    window.downloadRegistroPDF = function (docEst) {
      const jsPDF = window.jspdf.jsPDF;
      const pdf = new jsPDF('landscape', 'mm', 'a4');

      const lista = registros.filter(r => (r.documentoEstudiante || "") === docEst);
      if (!lista.length) {
        alert("No hay registros para este estudiante.");
        return;
      }

      const nombre = lista[0].nombreEstudiante || studentNamesByDoc[docEst] || "";

      // Encabezado con escudo
      if (escudoImg.complete) {
        try {
          pdf.addImage(escudoImg, 'PNG', 10, 8, 18, 22);
        } catch (e) {
          console.error("No se pudo agregar el escudo al PDF:", e);
        }
      }

      pdf.setFontSize(16);
      pdf.setFont(undefined, 'bold');
      pdf.text('INSTITUCIÓN EDUCATIVA DE MARÍA', 148, 15, { align: 'center' });
      pdf.setFontSize(12);
      pdf.text('Sede Rural Santa Juana (Primaria)', 148, 21, { align: 'center' });
      pdf.text('Seguimiento comportamental y disciplinario – 2026', 148, 27, { align: 'center' });

      pdf.setFontSize(11);
      const lineaEst = 'Estudiante: ' + (nombre || '________________') +
        '   Documento: ' + (docEst || '__________');
      pdf.text(lineaEst, 148, 34, { align: 'center' });

      const body = lista.map(r => [
        r.fecha || '',
        r.comportamiento || '',
        r.descargos || '',
        r.procedimiento || '',
        '', // firma estudiante/docente
        ''  // firma acudiente
      ]);

      pdf.autoTable({
        startY: 38,
        head: [['Fecha', 'Comportamiento', 'Descargos', 'Procedimiento', 'Firma estudiante/docente', 'Firma acudiente']],
        body,
        theme: 'grid',
        styles: {
          fontSize: 9,
          cellPadding: 3,
          overflow: 'linebreak',
          valign: 'top'
        },
        headStyles: {
          fillColor: [22, 163, 74],
          textColor: 255,
          fontStyle: 'bold',
          halign: 'center'
        },
        columnStyles: {
          0: { cellWidth: 22 },
          1: { cellWidth: 55 },
          2: { cellWidth: 55 },
          3: { cellWidth: 55 },
          4: { cellWidth: 35 },
          5: { cellWidth: 35 }
        },
        didDrawCell: function (data) {
          const idx = data.row.index;
          if (data.section === 'body') {
            const r = lista[idx];
            // Firma estudiante/docente
            if (data.column.index === 4 && r.firma) {
              try {
                pdf.addImage(r.firma, 'PNG',
                  data.cell.x + 2,
                  data.cell.y + 2,
                  data.cell.width - 4,
                  data.cell.height - 4
                );
              } catch (e) {
                console.error("Error agregando firma estudiante/docente:", e);
              }
            }
            // Firma acudiente
            if (data.column.index === 5 && r.firmaAcudiente) {
              try {
                pdf.addImage(r.firmaAcudiente, 'PNG',
                  data.cell.x + 2,
                  data.cell.y + 2,
                  data.cell.width - 4,
                  data.cell.height - 4
                );
              } catch (e) {
                console.error("Error agregando firma acudiente:", e);
              }
            }
          }
        }
      });

      const nombreArchivo = 'Seguimiento_' +
        (nombre || 'Estudiante').replace(/\s+/g, '_') +
        '_' + (docEst || '') + '.pdf';
      pdf.save(nombreArchivo);
    };

    // ---------- PDF EXCUSAS ----------
    window.downloadExcusasPDF = function (docEst) {
      const jsPDF = window.jspdf.jsPDF;
      const pdf = new jsPDF('landscape', 'mm', 'a4');

      const lista = excusas.filter(e => (e.documentoEstudiante || "") === docEst);
      if (!lista.length) {
        alert("No hay excusas para este estudiante.");
        return;
      }

      const nombre = studentNamesByDoc[docEst] || "";

      // Encabezado con escudo
      if (escudoImg.complete) {
        try {
          pdf.addImage(escudoImg, 'PNG', 10, 8, 18, 22);
        } catch (e) {
          console.error("No se pudo agregar el escudo al PDF:", e);
        }
      }

      pdf.setFontSize(16);
      pdf.setFont(undefined, 'bold');
      pdf.text('INSTITUCIÓN EDUCATIVA DE MARÍA', 148, 15, { align: 'center' });
      pdf.setFontSize(12);
      pdf.text('Sede Rural Santa Juana (Primaria)', 148, 21, { align: 'center' });
      pdf.text('Control y seguimiento de ausentismo escolar', 148, 27, { align: 'center' });

      pdf.setFontSize(11);
      const lineaEst = 'Estudiante: ' + (nombre || '________________') +
        '   Documento: ' + (docEst || '__________');
      pdf.text(lineaEst, 148, 34, { align: 'center' });

      const body = lista.map(e => [
        e.fechaInasistencia || '',
        e.motivoTipo || '',
        e.motivoDetalle || '',
        '' // firma acudiente
      ]);

      pdf.autoTable({
        startY: 38,
        head: [['Fecha de inasistencia', 'Motivo', 'Descripción', 'Firma acudiente']],
        body,
        theme: 'grid',
        styles: {
          fontSize: 9,
          cellPadding: 3,
          overflow: 'linebreak',
          valign: 'top'
        },
        headStyles: {
          fillColor: [22, 163, 74],
          textColor: 255,
          fontStyle: 'bold',
          halign: 'center'
        },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 40 },
          2: { cellWidth: 110 },
          3: { cellWidth: 40 }
        },
        didDrawCell: function (data) {
          const idx = data.row.index;
          if (data.section === 'body' && data.column.index === 3) {
            const e = lista[idx];
            if (e && e.firmaAcudiente) {
              try {
                pdf.addImage(e.firmaAcudiente, 'PNG',
                  data.cell.x + 2,
                  data.cell.y + 2,
                  data.cell.width - 4,
                  data.cell.height - 4
                );
              } catch (err) {
                console.error("Error agregando firma acudiente:", err);
              }
            }
          }
        }
      });

      const nombreArchivo = 'Excusas_' +
        (nombre || 'Estudiante').replace(/\s+/g, '_') +
        '_' + (docEst || '') + '.pdf';
      pdf.save(nombreArchivo);
    };

    // ---------- CARGA INICIAL ----------
    if (navigator.onLine) {
      cargarRegistros();
      cargarExcusas();
    } else {
      registros = JSON.parse(localStorage.getItem("registrosComportamentales") || "[]");
      excusas = JSON.parse(localStorage.getItem("excusasInasistencia") || "[]");
      registros.forEach(r => {
        if (r.documentoEstudiante && r.nombreEstudiante && !studentNamesByDoc[r.documentoEstudiante]) {
          studentNamesByDoc[r.documentoEstudiante] = r.nombreEstudiante;
        }
      });
      renderRegistros();
      renderExcusas();
    }
  </script>
</body>
</html>
