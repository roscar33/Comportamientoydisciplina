<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Seguimiento Disciplinario - Docente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Librer√≠as para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #1b5e20;       
      --primary-light: #2e7d32; 
      --accent: #0288d1;        
      --tools-color: #f57c00;
      --bg-body: #c8e6c9;       
      --text-main: #0f172a;
      --text-muted: #555;
      --card-bg: #ffffff;
      --border: #dcdcdc;
      --radius-xl: 24px;
      --radius-md: 12px;
      --shadow: 0 4px 15px rgba(27, 94, 32, 0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-body);
      min-height: 100vh;
      padding: 16px;
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 20px; }

    /* ENCABEZADO */
    .top-bar {
      display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 10px 20px;
      background: #ffffff; border-radius: 50px; box-shadow: var(--shadow); border: 1px solid #c8e6c9;
    }
    .brand-group { display: flex; align-items: center; gap: 12px; flex: 1; }
    .brand-logo { width: 55px; height: 55px; flex-shrink: 0; }
    .brand-logo img { width: 100%; height: 100%; object-fit: contain; }
    .brand-text { display: flex; flex-direction: column; justify-content: center; }
    .brand-title { font-size: 16px; font-weight: 800; color: var(--primary); line-height: 1.1; }
    .brand-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    /* CONEXI√ìN */
    .conn-indicator { width: 14px; height: 14px; border-radius: 50%; display: block; border: 2px solid #fff; box-shadow: 0 0 0 1px #e0e0e0; transition: background-color 0.3s; }
    .conn-online { background-color: #22c55e; box-shadow: 0 0 0 1px #22c55e; }
    .conn-offline { background-color: #ef4444; box-shadow: 0 0 0 1px #ef4444; }

    /* TABS */
    .nav-tabs { display: flex; background: #fff; padding: 5px; border-radius: 50px; box-shadow: var(--shadow); margin-bottom: 10px; gap: 5px; flex-wrap: wrap; }
    .nav-btn { flex: 1; border: none; background: transparent; padding: 12px; border-radius: 40px; font-weight: 700; color: #666; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; }
    .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(27, 94, 32, 0.3); }
    .nav-btn.active-tools { background: var(--tools-color); color: white; box-shadow: 0 2px 8px rgba(245, 124, 0, 0.3); }

    /* TARJETAS */
    .card { background: var(--card-bg); border-radius: var(--radius-xl); padding: 24px; box-shadow: var(--shadow); border: 1px solid white; position: relative; margin-bottom: 20px; }
    .card-title { font-size: 18px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
    .card-desc { font-size: 13px; color: var(--text-muted); line-height: 1.4; }

    /* FORMULARIO */
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 900px) { .form-grid.top-row { grid-template-columns: 1fr 1fr 2fr; } }
    .form-group { margin-bottom: 12px; position: relative; }
    label { display: block; font-size: 13px; font-weight: 700; color: #333; margin-bottom: 6px; }
    input, textarea, select { width: 100%; padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid #ccc; background: #fafafa; font-size: 14px; transition: all 0.2s; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1); }
    textarea { min-height: 100px; resize: vertical; }

    /* BUSCADOR */
    .search-wrapper { position: relative; }
    .search-wrapper input { padding-left: 35px; }
    .search-icon { position: absolute; left: 10px; top: 12px; font-size: 16px; opacity: 0.6; cursor: pointer; z-index: 5; }
    .custom-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--primary); border-top: none; border-radius: 0 0 12px 12px; max-height: 250px; overflow-y: auto; z-index: 100; box-shadow: 0 8px 16px rgba(0,0,0,0.15); display: none; }
    .custom-dropdown.show { display: block; }
    .dropdown-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
    .dropdown-item:last-child { border-bottom: none; }
    .dropdown-item:hover { background-color: #e8f5e9; }
    .item-nombre { font-weight: 700; color: #333; display: block; }
    .item-doc { font-size: 11px; color: #666; }

    /* BOTONES */
    .btn-row { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    button { border: none; padding: 12px 20px; border-radius: 30px; font-size: 14px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; }
    button:active { transform: scale(0.98); }
    .btn-save { background: var(--primary); color: white; flex: 2; box-shadow: 0 4px 10px rgba(27, 94, 32, 0.3); }
    .btn-clear { background: #d32f2f; color: white; font-size: 11px; padding: 5px 10px; box-shadow: none; width: auto; }
    .btn-historial { background: #455a64; color: white; width: 100%; margin-top: 10px; box-shadow: 0 4px 10px rgba(69, 90, 100, 0.3); }
    .btn-blue { background: #0288d1; color: white; font-size: 12px; padding: 8px 16px; }
    .btn-tools { background: var(--tools-color); color: white; font-size: 16px; padding: 18px; box-shadow: 0 4px 12px rgba(245, 124, 0, 0.3); transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-tools:hover { background: #ef6c00; transform: translateY(-2px); }
    .btn-icon { padding: 6px 10px; font-size: 12px; border-radius: 8px; }
    .btn-del { background: #ffebee; color: #c62828; }
    .btn-edit { background: #f1f8e9; color: #33691e; }
    .bg-gray { background: #eee; color: #333; }

    /* SECCIONES OCULTAS */
    .hidden-section { display: none; margin-top: 20px; border-top: 2px dashed #ddd; padding-top: 20px; animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* TABLAS */
    .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid #ddd; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; background: #fff; }
    th { background: var(--primary); color: white; text-align: left; padding: 12px; font-weight: 600; white-space: nowrap; }
    td { padding: 12px; border-bottom: 1px solid #eee; color: #333; vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    .sig-preview { max-width: 80px; height: auto; border: 1px solid #eee; border-radius: 4px; padding: 2px; }
    .tag-type { padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold; margin-left:5px; }
    .tag-acad { background:#e3f2fd; color:#0288d1; }
    .tag-comp { background:#e8f5e9; color:#2e7d32; }

    /* CANVAS FIRMA */
    canvas.signature-pad { width: 100%; height: 120px; background: #fff; border: 2px dashed #b0bec5; border-radius: var(--radius-md); cursor: crosshair; touch-action: none; display: block; }
    .sig-container { background: #f1f5f9; padding: 10px; border-radius: 12px; margin-bottom: 10px; }
    .sig-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .sig-label { font-size: 12px; font-weight: 700; color: #555; }

    /* ASISTENCIA */
    .attendance-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
    .att-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; }
    .att-name { font-weight: 600; font-size: 14px; color: #334155; }
    .att-options { display: flex; gap: 5px; }
    .att-btn { border: 1px solid #cbd5e1; background: #fff; color: #64748b; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .att-btn.active-p { background: #dcfce7; color: #166534; border-color: #86efac; }
    .att-btn.active-e { background: #ffedd5; color: #9a3412; border-color: #fdba74; }
    .att-btn.active-i { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }

    /* ESTUDIANTE BLOQUE HISTORIAL */
    .student-block { border: 1px solid #e0e0e0; border-radius: var(--radius-md); margin-bottom: 15px; overflow: hidden; }
    .student-info-bar { background: #f5f5f5; padding: 10px 15px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    
    @media(max-width: 600px) {
      .top-bar { padding: 10px; }
      .brand-group { gap: 10px; }
      .brand-logo { width: 45px; height: 45px; }
      .brand-title { font-size: 14px; }
      .brand-subtitle { font-size: 10px; }
      .nav-tabs { flex-direction: column; gap: 5px; }
      .form-grid.top-row { grid-template-columns: 1fr; }
      canvas.signature-pad { height: 100px; }
    }
  </style>
</head>
<body>

<div class="app-shell">
  
  <header class="top-bar">
    <div class="brand-group">
        <div class="brand-logo">
          <img src="escudo.png" alt="Escudo" onerror="this.src='https://placehold.co/100x100/1b5e20/ffffff?text=IE';">
        </div>
        <div class="brand-text">
          <div class="brand-title">Instituci√≥n Educativa de Mar√≠a</div>
          <div class="brand-subtitle">Sede Rural Santa Juana (Primaria) ¬∑ 2026</div>
          <div class="brand-subtitle" style="font-weight:600;">Seguimiento comportamental y disciplinario</div>
        </div>
    </div>
    <div id="connStatus" class="conn-indicator conn-offline" title="Desconectado"></div>
  </header>

  <nav class="nav-tabs">
    <button id="btnTabObs" class="nav-btn active" onclick="switchTab('obs')">Observaciones</button>
    <button id="btnTabAsis" class="nav-btn" onclick="switchTab('asis')">Asistencia</button>
    <button id="btnTabHerramientas" class="nav-btn" onclick="switchTab('herramientas')">Herramientas</button>
  </nav>

  <!-- VISTA 1: OBSERVACIONES -->
  <div id="view-obs">
      <section class="card">
        <h2 class="card-title">üìù Nuevo Registro</h2>
        <p class="card-desc">Observaciones comportamentales y acad√©micas.</p>

        <form id="formRegistro">
          <input type="hidden" id="editId">

          <div class="form-grid top-row">
            <div class="form-group">
                <label style="color:#d84315;">Tipo de registro</label>
                <select id="tipoRegistro" style="font-weight:bold; color:#d84315;">
                    <option value="Comportamental">Comportamental</option>
                    <option value="Acad√©mico">Acad√©mico</option>
                </select>
            </div>
            <div class="form-group">
              <label>Fecha</label>
              <input type="date" id="fecha" required>
            </div>
            <div class="form-group">
              <label>Seleccionar Estudiante</label>
              <div class="search-wrapper">
                  <span class="search-icon" onclick="document.getElementById('inputBusquedaEstudiante').focus()">üîç</span>
                  <input type="text" id="inputBusquedaEstudiante" placeholder="Escriba o busque..." autocomplete="off" required>
                  <input type="hidden" id="idEstudianteSeleccionado">
                  <div id="dropdownEstudiantes" class="custom-dropdown"></div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Descripci√≥n del comportamiento / Novedad</label>
            <textarea id="comportamiento" placeholder="Explique la situaci√≥n presentada..."></textarea>
          </div>

          <div class="form-grid">
            <div class="form-group">
                <label>Descargos (versi√≥n del estudiante)</label>
                <textarea id="descargos" placeholder="Lo que manifiesta el estudiante..."></textarea>
            </div>
            <div class="form-group">
                <label>Procedimiento / acciones a seguir</label>
                <textarea id="procedimiento" placeholder="Compromisos o sanciones..."></textarea>
            </div>
          </div>

          <!-- SECCI√ìN DE FIRMAS ACTUALIZADA: 2 CANVAS -->
          <div class="form-grid">
             <!-- Firma Estudiante -->
             <div class="sig-container">
                <div class="sig-header">
                    <span class="sig-label">Firma Estudiante</span>
                    <button type="button" class="btn-clear" onclick="limpiarFirma('sigStudent')">Borrar</button>
                </div>
                <canvas id="sigStudent" class="signature-pad"></canvas>
             </div>
             
             <!-- Firma Docente -->
             <div class="sig-container">
                <div class="sig-header">
                    <span class="sig-label">Firma Docente</span>
                    <button type="button" class="btn-clear" onclick="limpiarFirma('sigTeacher')">Borrar</button>
                </div>
                <canvas id="sigTeacher" class="signature-pad"></canvas>
             </div>
          </div>

          <div class="btn-row">
            <button type="submit" class="btn-save" id="btnGuardar">Guardar registro</button>
          </div>
          <div style="margin-top:10px; display:none;" id="divCancel">
             <button type="button" class="bg-gray btn-icon" style="width:100%" onclick="cancelarEdicion()">Cancelar Edici√≥n</button>
          </div>

          <button type="button" class="btn-historial" onclick="toggleHistorial('historialObs')">üìÇ Ver Historial de Registros</button>
        </form>

        <div id="historialObs" class="hidden-section">
            <h3 style="color:#1b5e20; border-bottom:1px solid #ddd; padding-bottom:5px;">Historial Completo</h3>
            <div class="form-group">
                <input type="text" id="buscador" placeholder="üîç Buscar registro antiguo..." onkeyup="renderRegistros()">
            </div>
            <div id="listaRegistros">
                <div style="text-align:center; padding:20px; color:#888;">Cargando datos...</div>
            </div>
        </div>
      </section>
  </div>

  <!-- VISTA 2: ASISTENCIA -->
  <div id="view-asis" style="display:none;">
      <section class="card" style="border-left: 5px solid #0288d1;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 class="card-title" style="color:#0288d1; margin:0;">Asistencia Diaria</h2>
            <input type="date" id="fechaAsistencia" style="padding:8px; border-radius:8px; border:1px solid #ccc;" onchange="cargarAsistenciaDelDia()">
        </div>
        <div id="attendanceList" class="attendance-grid">
            <div style="text-align:center; color:#888;">Cargando lista...</div>
        </div>
        <div class="btn-row" style="margin-top:20px;">
            <button class="btn-blue" onclick="guardarAsistencia()">üíæ Guardar Asistencia</button>
        </div>
        <div style="margin:25px 0 15px; border-bottom:2px dashed #e0e0e0; color:#0288d1; font-weight:700; font-size:14px; text-transform:uppercase;">Reportes</div>
        <div style="display:flex; gap:10px; align-items:center; background:#f1f9ff; padding:10px; border-radius:12px;">
            <input type="month" id="mesReporte" style="flex:1;">
            <button class="btn-icon bg-gray" onclick="descargarReporteMensual()">üìä Descargar Matriz</button>
        </div>
        <button type="button" class="btn-historial" style="background:#0288d1;" onclick="toggleHistorial('historialExc')">üì© Ver Historial de Excusas</button>
        <div id="historialExc" class="hidden-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="color:#0288d1; margin:0;">Excusas Recibidas</h3>
                <button class="btn-icon bg-gray" onclick="descargarExcusasPDF()">üìÑ PDF</button>
            </div>
            <div id="listaExcusas">
                <div style="text-align:center; padding:20px; color:#888;">Cargando excusas...</div>
            </div>
        </div>
      </section>
  </div>

  <!-- VISTA 3: HERRAMIENTAS -->
  <div id="view-herramientas" style="display:none;">
    <section class="card" style="border-left: 5px solid var(--tools-color);">
        <h2 class="card-title" style="color:var(--tools-color);">üß∞ Herramientas Docentes</h2>
        <p class="card-desc">Accesos directos a plataformas externas.</p>
        <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 15px;">
            <a href="https://roscar33.github.io/Diariodeprocesos2026/" target="_blank" style="text-decoration:none;">
                <button class="btn-tools" style="width:100%;">üìì DIARIO DE PROCESOS</button>
            </a>
            <a href="https://roscar33.github.io/PLANILLASDENOTAS/" target="_blank" style="text-decoration:none;">
                <button class="btn-tools" style="width:100%;">üìä PLANILLA DE NOTAS</button>
            </a>
            <a href="https://roscar33.github.io/Bancodecriterios/" target="_blank" style="text-decoration:none;">
                <button class="btn-tools" style="width:100%;">üìö TEMARIOS</button>
            </a>
        </div>
    </section>
  </div>
</div>

<script>
  // Datos base
  const estudiantesBase = [
    { doc: "1157463842", nombre: "BERRIO CORREA VALENTINA" },
    { doc: "1038213324", nombre: "GUZMAN CORREA DYLAN" },
    { doc: "1072263423", nombre: "MEDINA POLO JESUS DAVID" },
    { doc: "1041636093", nombre: "MEJIA VALLEJO TOMAS" },
    { doc: "1041636021", nombre: "VARELAS BARRIENTOS MAXIMILIANO" }
  ];
  window.estudiantesBase = estudiantesBase;

  document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("inputBusquedaEstudiante");
      const dropdown = document.getElementById("dropdownEstudiantes");
      const hiddenInput = document.getElementById("idEstudianteSeleccionado");
      function renderDropdown(filterText = "") {
          dropdown.innerHTML = "";
          const filterUpper = filterText.toUpperCase();
          const filtrados = estudiantesBase.filter(est => est.nombre.includes(filterUpper) || est.doc.includes(filterUpper));
          if(filtrados.length === 0) {
              dropdown.innerHTML = '<div style="padding:10px; color:#888; font-size:12px;">No se encontraron resultados</div>';
              return;
          }
          filtrados.forEach(est => {
              const item = document.createElement("div");
              item.className = "dropdown-item";
              item.innerHTML = `<span class="item-nombre">${est.nombre}</span><span class="item-doc">DOC: ${est.doc}</span>`;
              item.onclick = () => {
                  input.value = est.nombre;
                  hiddenInput.value = est.doc;
                  dropdown.classList.remove("show");
              };
              dropdown.appendChild(item);
          });
      }
      input.addEventListener("focus", () => { renderDropdown(input.value); dropdown.classList.add("show"); });
      input.addEventListener("input", (e) => { hiddenInput.value = ""; renderDropdown(e.target.value); dropdown.classList.add("show"); });
      document.addEventListener("click", (e) => {
          if (!input.contains(e.target) && !dropdown.contains(e.target) && !e.target.classList.contains('search-icon')) {
              dropdown.classList.remove("show");
          }
      });
  });
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
    authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
    projectId: "diariodeprocesos-6f78d",
    storageBucket: "diariodeprocesos-6f78d.firebasestorage.app",
    messagingSenderId: "487922338632",
    appId: "1:487922338632:web:47fc48c23dbea064b0817d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let allRegistros = [];
  let allExcusas = [];
  let asistenciaTemp = {};

  const updateStatus = (online) => {
    const el = document.getElementById('connStatus');
    el.className = online ? 'conn-indicator conn-online' : 'conn-indicator conn-offline';
    el.title = online ? 'En l√≠nea' : 'Desconectado';
  };
  window.addEventListener('online', () => updateStatus(true));
  window.addEventListener('offline', () => updateStatus(false));
  updateStatus(navigator.onLine);

  window.switchTab = (tab) => {
      document.getElementById('view-obs').style.display = 'none';
      document.getElementById('view-asis').style.display = 'none';
      document.getElementById('view-herramientas').style.display = 'none';
      document.getElementById('btnTabObs').className = 'nav-btn';
      document.getElementById('btnTabAsis').className = 'nav-btn';
      document.getElementById('btnTabHerramientas').className = 'nav-btn';

      if (tab === 'obs') {
          document.getElementById('view-obs').style.display = 'block';
          document.getElementById('btnTabObs').className = 'nav-btn active';
          setTimeout(resizeAllCanvas, 200);
      } else if (tab === 'asis') {
          document.getElementById('view-asis').style.display = 'block';
          document.getElementById('btnTabAsis').className = 'nav-btn active';
      } else if (tab === 'herramientas') {
          document.getElementById('view-herramientas').style.display = 'block';
          document.getElementById('btnTabHerramientas').className = 'nav-btn active-tools';
      }
  };

  window.toggleHistorial = (id) => {
      const el = document.getElementById(id);
      el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
  };

  document.getElementById('fecha').valueAsDate = new Date();
  document.getElementById('fechaAsistencia').valueAsDate = new Date();
  const today = new Date();
  document.getElementById('mesReporte').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

  // --- ASISTENCIA LOGIC ---
  window.renderAsistencia = () => {
      const container = document.getElementById('attendanceList');
      let html = '';
      window.estudiantesBase.forEach(est => {
          const estado = asistenciaTemp[est.doc] || 'P';
          html += `<div class="att-row"><div><div class="att-name">${est.nombre}</div><div class="att-doc">${est.doc}</div></div>
              <div class="att-options">
                  <button class="att-btn ${estado === 'P' ? 'active-p' : ''}" onclick="setAtt('${est.doc}', 'P')">Asisti√≥</button>
                  <button class="att-btn ${estado === 'E' ? 'active-e' : ''}" onclick="setAtt('${est.doc}', 'E')">Excusa</button>
                  <button class="att-btn ${estado === 'I' ? 'active-i' : ''}" onclick="setAtt('${est.doc}', 'I')">Injustif.</button>
              </div></div>`;
      });
      container.innerHTML = html;
  };

  window.setAtt = (doc, status) => { asistenciaTemp[doc] = status; renderAsistencia(); };
  window.cargarAsistenciaDelDia = async () => {
      const fecha = document.getElementById('fechaAsistencia').value;
      if(!fecha) return;
      try {
          const docSnap = await getDoc(doc(db, "controlAsistencia", fecha));
          asistenciaTemp = (docSnap.exists() && docSnap.data().detalles) ? 
              docSnap.data().detalles.reduce((acc, d) => ({...acc, [d.doc]: d.estado}), {}) : {};
          renderAsistencia();
      } catch (e) { console.error(e); }
  };
  window.guardarAsistencia = async () => {
      const fecha = document.getElementById('fechaAsistencia').value;
      if(!fecha) return alert("Seleccione fecha");
      const dataToSave = {
          fecha: fecha, timestamp: new Date().toISOString(),
          detalles: window.estudiantesBase.map(est => ({ doc: est.doc, nombre: est.nombre, estado: asistenciaTemp[est.doc] || 'P' }))
      };
      try { await setDoc(doc(db, "controlAsistencia", fecha), dataToSave); alert("‚úÖ Asistencia guardada."); } catch(e) { alert("Error: " + e.message); }
  };
  window.cargarAsistenciaDelDia();

  // --- REPORTE MENSUAL ---
  window.descargarReporteMensual = async () => {
      const mesInput = document.getElementById('mesReporte').value;
      if(!mesInput) return alert("Seleccione un mes.");
      const [year, month] = mesInput.split('-');
      const daysInMonth = new Date(year, month, 0).getDate();
      const q = query(collection(db, "controlAsistencia"), where("fecha", ">=", `${mesInput}-01`), where("fecha", "<=", `${mesInput}-${daysInMonth}`));
      const querySnapshot = await getDocs(q);
      const asistenciaMes = {}; 
      querySnapshot.forEach((doc) => {
          const d = doc.data();
          asistenciaMes[d.fecha] = (d.detalles || []).reduce((acc, det) => ({...acc, [det.doc]: det.estado}), {});
      });

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l', 'mm', 'a4');
      pdf.setFontSize(14); pdf.setTextColor(27, 94, 32);
      pdf.text(`Control de Asistencia Mensual - ${mesInput}`, 14, 15);
      
      const headRow = ['Estudiante'];
      for(let i=1; i<=daysInMonth; i++) headRow.push(String(i));
      headRow.push('Fallas', 'Excusas');

      const bodyData = window.estudiantesBase.map(est => {
          const row = [est.nombre];
          let totalFallas = 0, totalExcusas = 0;
          for(let i=1; i<=daysInMonth; i++) {
              const f = `${mesInput}-${String(i).padStart(2,'0')}`;
              const e = asistenciaMes[f] ? asistenciaMes[f][est.doc] : null;
              if(e === 'I') { row.push('X'); totalFallas++; }
              else if(e === 'E') { row.push('E'); totalExcusas++; }
              else if(e === 'P') { row.push('‚Ä¢'); }
              else row.push(' ');
          }
          row.push(String(totalFallas), String(totalExcusas));
          return row;
      });

      pdf.autoTable({
          startY: 20, head: [headRow], body: bodyData, theme: 'grid',
          styles: { fontSize: 6, cellPadding: 1, halign: 'center' },
          columnStyles: { 0: { halign: 'left', cellWidth: 40 } },
          headStyles: { fillColor: [27, 94, 32] },
          didParseCell: function(data) {
              if (data.section === 'body' && data.column.index > 0) {
                  if(data.cell.raw === 'X') data.cell.styles.textColor = [200, 0, 0];
                  if(data.cell.raw === 'E') data.cell.styles.textColor = [200, 100, 0];
              }
          }
      });
      pdf.save(`Asistencia_Mensual_${mesInput}.pdf`);
  };

  // --- CANVAS MULTIPLE SETUP ---
  const canvasIds = ['sigStudent', 'sigTeacher'];
  const pads = {};

  function initPad(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext('2d');
      let isDrawing = false;
      pads[id] = { canvas, ctx };

      const getPos = (e) => {
          const rect = canvas.getBoundingClientRect();
          const t = e.touches ? e.touches[0] : e;
          return { x: t.clientX - rect.left, y: t.clientY - rect.top };
      };
      
      const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); };
      const move = (e) => { e.preventDefault(); if(!isDrawing) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); };
      const end = () => { isDrawing = false; };

      canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
      canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
  }

  function resizeAllCanvas() {
      canvasIds.forEach(id => {
          const { canvas, ctx } = pads[id];
          if(!canvas.offsetParent) return; // Si est√° oculto
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          // Guardar contenido si existe
          const temp = ctx.getImageData(0,0,canvas.width, canvas.height); 
          // Ajustar tama√±o
          canvas.width = canvas.offsetWidth * ratio;
          canvas.height = canvas.offsetHeight * ratio;
          ctx.scale(ratio, ratio);
          // No restauramos temp porque al cambiar ratio se distorsiona, mejor limpiar o redibujar si se tuviera historial
      });
  }

  window.addEventListener('resize', resizeAllCanvas);
  
  // Inicializar al cargar
  canvasIds.forEach(id => initPad(id));
  setTimeout(resizeAllCanvas, 500);

  window.limpiarFirma = (id) => {
      const { canvas, ctx } = pads[id];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
  };
  
  function isCanvasBlank(canvas) {
      const context = canvas.getContext('2d');
      const pixelBuffer = new Uint32Array(context.getImageData(0, 0, canvas.width, canvas.height).data.buffer);
      return !pixelBuffer.some(color => color !== 0);
  }

  // --- FIRESTORE LISTENERS ---
  onSnapshot(collection(db, "registrosComportamentales"), (snap) => {
    allRegistros = [];
    snap.forEach(doc => allRegistros.push({id: doc.id, ...doc.data()}));
    renderRegistros();
  });
  onSnapshot(collection(db, "excusasInasistencia"), (snap) => {
    allExcusas = [];
    snap.forEach(doc => allExcusas.push({id: doc.id, ...doc.data()}));
    renderExcusas();
  });

  // --- RENDER REGISTROS ---
  window.renderRegistros = () => {
    const container = document.getElementById('listaRegistros');
    const search = document.getElementById('buscador').value.toLowerCase();
    const filtered = allRegistros.filter(r => (r.nombreEstudiante||'').toLowerCase().includes(search) || (r.documentoEstudiante||'').includes(search));

    if(filtered.length === 0) {
        container.innerHTML = '<div style="padding:15px; text-align:center; color:#888;">No se encontraron registros.</div>';
        return;
    }

    const grupos = {};
    filtered.forEach(r => {
        const key = r.documentoEstudiante || 'SIN_DOC';
        if(!grupos[key]) grupos[key] = { nombre: r.nombreEstudiante, docs: [] };
        grupos[key].docs.push(r);
    });

    let html = '';
    Object.keys(grupos).forEach(key => {
        const g = grupos[key];
        g.docs.sort((a,b) => (a.fecha||'') < (b.fecha||'') ? 1 : -1);
        html += `<div class="student-block">
            <div class="student-info-bar">
                <div><div class="st-name">${g.nombre || 'Sin Nombre'}</div><div class="st-doc">Doc: ${key} ¬∑ Registros: ${g.docs.length}</div></div>
                <button class="btn-blue" onclick="descargarPDF('${key}')">Descargar PDF</button>
            </div>
            <div class="table-container"><table>
                <thead><tr><th style="width:90px;">Fecha</th><th>Detalle</th><th>Estado Firmas</th><th style="width:90px;">Acci√≥n</th></tr></thead>
                <tbody>`;
        g.docs.forEach(r => {
            const tipo = r.tipoRegistro || 'Comportamental';
            const claseTipo = tipo === 'Acad√©mico' ? 'tag-acad' : 'tag-comp';
            
            // L√≥gica de estado de firmas
            let statusFirma = [];
            if(r.firmaEstudiante) statusFirma.push('<span style="color:green; font-size:10px;">Est:OK</span>');
            else statusFirma.push('<span style="color:red; font-size:10px;">Est:--</span>');
            
            // Compatibilidad: Si tiene r.firma pero no firmaDocente, asumimos que r.firma es Docente (legado)
            if(r.firmaDocente || r.firma) statusFirma.push('<span style="color:green; font-size:10px;">Doc:OK</span>');
            else statusFirma.push('<span style="color:red; font-size:10px;">Doc:--</span>');

            if(r.firmaAcudiente) statusFirma.push('<span style="color:green; font-size:10px;">Acu:OK</span>');
            else statusFirma.push('<span style="color:#d84315; font-size:10px; font-weight:bold;">Acu:PEN</span>');

            html += `<tr>
                    <td><div style="font-size:12px;">${r.fecha}</div><span class="tag-type ${claseTipo}">${tipo.substring(0,4)}.</span></td>
                    <td><div style="font-weight:600; margin-bottom:4px;">${r.comportamiento}</div><div style="font-size:11px; color:#666;"><em>${r.procedimiento}</em></div></td>
                    <td><div style="display:flex; flex-direction:column;">${statusFirma.join('')}</div></td>
                    <td><div style="display:flex; gap:5px;">
                        <button class="bg-gray btn-icon btn-edit" onclick="editar('${r.id}')">‚úèÔ∏è</button>
                        <button class="bg-gray btn-icon btn-del" onclick="eliminarDocumento('${r.id}', 'registrosComportamentales')">üóëÔ∏è</button>
                    </div></td>
                </tr>`;
        });
        html += `</tbody></table></div></div>`;
    });
    container.innerHTML = html;
  };

  window.renderExcusas = () => { /* ...C√≥digo de excusas similar al anterior... */ };

  // --- GUARDAR ---
  const form = document.getElementById('formRegistro');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnGuardar');
    const id = document.getElementById('editId').value;
    const docSeleccionado = document.getElementById("idEstudianteSeleccionado").value;
    const nombreInput = document.getElementById("inputBusquedaEstudiante").value;

    if(!nombreInput) { alert("‚ö†Ô∏è Seleccione un estudiante."); return; }
    if(!docSeleccionado) { 
        const match = window.estudiantesBase.find(est => est.nombre === nombreInput);
        if(!match) { alert("‚ö†Ô∏è Seleccione un estudiante de la lista."); return; }
    }
    
    // Validar que al menos el docente firme
    if(!id && isCanvasBlank(pads['sigTeacher'].canvas)) { alert("El docente debe firmar."); return; }

    btn.disabled = true; btn.innerText = "Guardando...";
    
    const data = {
        tipoRegistro: document.getElementById('tipoRegistro').value,
        fecha: document.getElementById('fecha').value,
        documentoEstudiante: docSeleccionado || "SIN_DOC",
        nombreEstudiante: nombreInput,
        comportamiento: document.getElementById('comportamiento').value,
        descargos: document.getElementById('descargos').value,
        procedimiento: document.getElementById('procedimiento').value
    };
    
    // Guardar firmas individualmente
    if(!isCanvasBlank(pads['sigStudent'].canvas)) data.firmaEstudiante = pads['sigStudent'].canvas.toDataURL();
    if(!isCanvasBlank(pads['sigTeacher'].canvas)) data.firmaDocente = pads['sigTeacher'].canvas.toDataURL();

    try {
        if(id) {
            await updateDoc(doc(db, "registrosComportamentales", id), data);
            alert("Registro actualizado.");
            cancelarEdicion();
        } else {
            await addDoc(collection(db, "registrosComportamentales"), { ...data, timestamp: new Date().toISOString() });
            alert("Guardado con √©xito.");
            form.reset();
            document.getElementById("inputBusquedaEstudiante").value = "";
            document.getElementById("idEstudianteSeleccionado").value = "";
            window.limpiarFirma('sigStudent');
            window.limpiarFirma('sigTeacher');
        }
    } catch(err) { alert("Error: " + err.message); }
    btn.disabled = false; btn.innerText = "Guardar registro";
  });

  window.eliminarDocumento = async (id, coleccion) => {
      if(confirm("‚ö†Ô∏è ¬øEliminar registro?")) { try { await deleteDoc(doc(db, coleccion, id)); } catch(e) { alert("Error: " + e.message); } }
  };

  window.editar = (id) => {
    const r = allRegistros.find(x => x.id === id);
    if(!r) return;
    document.getElementById('editId').value = r.id;
    document.getElementById('tipoRegistro').value = r.tipoRegistro;
    document.getElementById('fecha').value = r.fecha;
    document.getElementById("inputBusquedaEstudiante").value = r.nombreEstudiante;
    document.getElementById("idEstudianteSeleccionado").value = r.documentoEstudiante;
    document.getElementById('comportamiento').value = r.comportamiento;
    document.getElementById('descargos').value = r.descargos;
    document.getElementById('procedimiento').value = r.procedimiento;
    
    // Nota: Las firmas no se pueden "editar" pint√°ndolas de nuevo en el canvas desde base64 f√°cilmente,
    // as√≠ que se dejan los canvas limpios para nuevas firmas si se desea actualizar.
    
    document.getElementById('btnGuardar').innerText = "Actualizar (Firmar de nuevo si es necesario)";
    document.getElementById('divCancel').style.display = 'block';
    window.scrollTo({top:0, behavior:'smooth'});
  };

  window.cancelarEdicion = () => {
    form.reset();
    document.getElementById("inputBusquedaEstudiante").value = "";
    document.getElementById("idEstudianteSeleccionado").value = "";
    document.getElementById('editId').value = '';
    document.getElementById('btnGuardar').innerText = "Guardar registro";
    document.getElementById('divCancel').style.display = 'none';
    window.limpiarFirma('sigStudent');
    window.limpiarFirma('sigTeacher');
  };

  // --- PDF CON 3 COLUMNAS DE FIRMA ---
  window.descargarPDF = (docId) => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('l', 'mm', 'a4'); // Horizontal (landscape) para que quepan las 3 firmas
    const recs = allRegistros.filter(r => r.documentoEstudiante === docId);
    if(!recs.length) return;

    pdf.setFillColor(27, 94, 32); pdf.rect(0, 0, 297, 30, 'F');
    pdf.setTextColor(255, 255, 255); pdf.setFontSize(16);
    pdf.text("Instituci√≥n Educativa de Mar√≠a - Sede Santa Juana", 14, 12);
    pdf.setFontSize(10); pdf.text("Reporte Disciplinario Detallado", 14, 20);
    
    pdf.setTextColor(0,0,0); 
    pdf.text(`Estudiante: ${recs[0].nombreEstudiante}`, 14, 40);
    pdf.text(`Documento: ${docId}`, 14, 46);
    
    // Cuerpo con 3 columnas de firma vac√≠as (se llenan con imagen)
    const body = recs.map(r => [
        r.fecha,
        r.tipoRegistro ? r.tipoRegistro.substring(0,4) : "Comp",
        r.comportamiento,
        r.procedimiento,
        "", // Estudiante
        "", // Docente
        ""  // Acudiente
    ]);

    pdf.autoTable({
        startY: 55,
        head: [['Fecha', 'Tipo', 'Observaci√≥n', 'Procedimiento', 'F. Estudiante', 'F. Docente', 'F. Acudiente']],
        body: body,
        headStyles: { fillColor: [27, 94, 32] },
        bodyStyles: { minCellHeight: 20 }, // M√°s altura para las firmas
        columnStyles: {
            0: { cellWidth: 25 },
            1: { cellWidth: 15 },
            2: { cellWidth: 60 },
            3: { cellWidth: 60 },
            4: { cellWidth: 35 },
            5: { cellWidth: 35 },
            6: { cellWidth: 35 }
        },
        didDrawCell: function(data) {
            if (data.section === 'body') {
                const r = recs[data.row.index];
                
                // Columna 4 (index 4): Firma Estudiante
                if(data.column.index === 4 && r.firmaEstudiante) {
                    try { pdf.addImage(r.firmaEstudiante, 'PNG', data.cell.x + 2, data.cell.y + 2, 30, 15); } catch(e){}
                }
                
                // Columna 5 (index 5): Firma Docente
                // Soporte retroactivo: r.firmaDocente O r.firma (viejo)
                const fDoc = r.firmaDocente || r.firma; 
                if(data.column.index === 5 && fDoc) {
                    try { pdf.addImage(fDoc, 'PNG', data.cell.x + 2, data.cell.y + 2, 30, 15); } catch(e){}
                }

                // Columna 6 (index 6): Firma Acudiente
                if(data.column.index === 6 && r.firmaAcudiente) {
                    try { pdf.addImage(r.firmaAcudiente, 'PNG', data.cell.x + 2, data.cell.y + 2, 30, 15); } catch(e){}
                }
            }
        }
    });

    pdf.save(`Reporte_Completo_${recs[0].nombreEstudiante}.pdf`);
  };

  // PDF Excusas (Mantenemos simple)
  window.descargarExcusasPDF = () => {
      // ... c√≥digo similar al anterior para excusas ...
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      pdf.setFillColor(2, 136, 209); pdf.rect(0, 0, 210, 30, 'F');
      pdf.setTextColor(255, 255, 255); pdf.text("Control de Ausentismo", 14, 18);
      
      const body = allExcusas.map(e => {
          // B√∫squeda de nombre
          const match = window.estudiantesBase.find(est => est.doc === e.documentoEstudiante);
          const nom = match ? match.nombre : e.documentoEstudiante;
          return [e.fechaInasistencia, nom, e.motivoDetalle, ""];
      });

      pdf.autoTable({
          startY: 40,
          head: [['Fecha', 'Estudiante', 'Detalle', 'Firma Acudiente']],
          body: body,
          bodyStyles: { minCellHeight: 15 },
          didDrawCell: function(data) {
              if (data.section === 'body' && data.column.index === 3) {
                  const exc = allExcusas[data.row.index];
                  if(exc.firmaAcudiente) {
                      try { pdf.addImage(exc.firmaAcudiente, 'PNG', data.cell.x+2, data.cell.y+2, 25, 10); } catch(e){}
                  }
              }
          }
      });
      pdf.save("Reporte_Excusas.pdf");
  };
</script>
</body>
</html>


